# プロセス設計書（PDD: Process Design Document）

## 1. 概要

| 項目 | 内容 |
|------|------|
| プロセス名 | 経費登録自動化プロセス |
| 対象システム | UiPath Demo 経費登録システム |

## 2. 業務プロセス詳細

| No. | 業務内容概要 | 利用するApp/処理する資料 | 業務内容の詳細 | 担当者 | RPA化対象 | 備考 |
|-----|-------------|-------------------------|----------------|--------|-----------|------|
| 1 | データファイル存在確認 | Excel、ローカルファイルシステム | data.xlsxファイルの存在を確認し、存在しない場合はURL（https://www.expense-demo.com/data.xlsx）からダウンロードする | ロボット | 対象 | ファイル存在時はメッセージ表示 |
| 2 | Excelデータ読み取り | Excel（data.xlsx） | Sheet1からヘッダー付きデータを読み取り、処理対象行数を確認する | ロボット | 対象 | pandasライブラリ使用 |
| 3 | WebDriver初期化 | Microsoft Edge | Selenium WebDriverを初期化し、Edgeブラウザを起動する | ロボット | 対象 | 複数の初期化方法を試行 |
| 4 | 経費登録サイトアクセス | Webブラウザ | https://www.expense-demo.com/ にアクセスする | ロボット | 対象 | ページ読み込み完了まで待機 |
| 5 | 経費登録メニュー選択 | 経費登録Webアプリ | 「経費を登録する」メニューをクリックして経費一覧画面に遷移 | ロボット | 対象 | 複数セレクタで要素検索 |
| 6 | 明細登録処理（各行） | 経費登録Webアプリ、Excel | 各行データについて以下を実行：<br>・明細登録ボタンクリック<br>・フォーム入力（タイトル、種別、金額、備考）<br>・登録ボタンクリック<br>・登録コード取得<br>・Excelへの書き戻し<br>・戻るボタンクリック | ロボット | 対象 | エラー時も次行に継続 |
| 7 | 処理完了通知 | GUI/CUI | 処理結果（総行数、成功件数、失敗件数、所要時間）を表示 | ロボット | 対象 | tkinter messagebox使用 |
| 8 | ブラウザ終了 | Webブラウザ | ユーザー確認後にWebDriverを終了してブラウザを閉じる | ロボット | 対象 | driver.quit()実行 |

## 3. 入力データ仕様

### 3.1 Excelファイル仕様
- **ファイル名**: data.xlsx
- **シート名**: Sheet1
- **ヘッダー行**: 1行目
- **必須カラム**: タイトル、種別、金額、備考、番号

### 3.2 カラム詳細
| カラム名 | データ型 | 説明 | 入力例 |
|----------|----------|------|--------|
| タイトル | 文字列 | 経費のタイトル | "交際費"、"宿泊費" |
| 種別 | 文字列 | 経費の種別（立替、仮払、その他） | "立替" |
| 金額 | 数値 | 経費金額 | 5030 |
| 備考 | 文字列 | 備考欄 | "先月分" |
| 番号 | 文字列 | 登録コード格納欄（処理後に自動入力） | "563696" |

## 4. 出力データ仕様

### 4.1 Excelファイル更新
- **対象ファイル**: data.xlsx
- **更新カラム**: 番号
- **更新内容**: Webアプリから取得した6桁の登録コード

### 4.2 ログファイル
- **ファイル名**: expense_automation.log
- **形式**: テキストファイル
- **内容**: 処理ログ（INFO/ERROR レベル）

## 5. 業務フロー図

```
[開始]
　↓
[data.xlsx存在確認]
　↓（存在しない場合）
[URLからダウンロード]
　↓
[Excelデータ読み取り]
　↓
[WebDriver初期化]
　↓
[経費登録サイトアクセス]
　↓
[経費登録メニュークリック]
　↓
[各行データをループ処理]
　├─[明細登録ボタンクリック]
　├─[フォーム入力]
　├─[登録ボタンクリック]
　├─[登録コード取得]
　├─[Excelに書き戻し]
　└─[戻るボタンクリック]
　↓
[処理完了通知表示]
　↓
[ユーザー確認待ち]
　↓
[ブラウザ終了]
　↓
[終了]
```

## 6. エラーハンドリング

| エラー種別 | 対応方法 | 継続可否 |
|------------|----------|----------|
| ファイルダウンロード失敗 | エラーメッセージ表示後処理停止 | 停止 |
| Excel読み取り失敗 | エラーメッセージ表示後処理停止 | 停止 |
| WebDriver初期化失敗 | 複数の初期化方法を試行、全て失敗なら停止 | 停止 |
| 要素検出失敗 | 複数セレクタで再試行、3回失敗で当該行スキップ | 継続 |
| フォーム入力失敗 | リトライ後、失敗なら当該行スキップ | 継続 |
| 登録コード取得失敗 | 自動生成コード（AUTO_YYYYMMDD_HHMMSS）を使用 | 継続 |

## 7. 非機能要件

| 項目 | 要件 |
|------|------|
| パフォーマンス | 1行あたり約20秒以内で処理完了 |
| 可用性 | オフライン環境でも動作（ローカルドライバ使用） |
| 保守性 | 単一ファイル構成、明確な関数分割 |
| セキュリティ | 認証情報のハードコーディング禁止 |
| ログ | 全処理の詳細ログを記録 |

## 8. 前提条件・制約事項

### 8.1 前提条件
- Python 3.10.11がインストール済み
- Microsoft Edgeブラウザがインストール済み
- インターネット接続（初回のみ、データダウンロード用）
- 必要なPythonライブラリがインストール済み

### 8.2 制約事項
- 経費登録サイトの画面構成変更時は要メンテナンス
- 同時実行は不可（ブラウザの排他制御なし）
- Excelファイルが他アプリで開かれている場合は書き込み失敗

## 9. 関連資料

| 資料名 | 場所 | 説明 |
|--------|------|------|
| Main.xaml | ./Main.xaml | 元となるUiPathワークフロー |
| 設計書.md | ./設計書.md | 詳細設計書 |
| 経費登録.py | ./経費登録.py | 実装ファイル |
| requirements.txt | ../requirements.txt | 依存ライブラリ一覧 |
