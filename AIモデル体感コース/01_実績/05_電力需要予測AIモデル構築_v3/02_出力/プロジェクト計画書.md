# 電力需要予測AIモデル構築 - プロジェクト計画書 v3.0

※ この資料は教育用のサンプルです。

**バージョン**: v3.0  
**リリース日**: 2025年10月25日  
**主要特性**: CLI + Webダッシュボード + 組み合わせ検証統合版 + localStorage学習年選択保持機能

---

## 1. 目的・背景

### 1.1. 目的・背景
電力需要予測の精度向上とエネルギー管理最適化を目的とした、機械学習を活用した包括的な予測システムの構築である。4つの異なる機械学習アルゴリズム（Keras、LightGBM、PyCaret、RandomForest）を用いたアンサンブル予測システムに加え、**Webダッシュボード統合**による操作性の劇的改善、**組み合わせ検証機能（ローリング時系列交差検証）**による最適学習年自動探索、**localStorage学習年選択保持機能**によるユーザー体験向上により、電力需要の短期・中期予測精度の最大化と運用効率化・科学的最適化・操作利便性を実現する。

本プロジェクトは、過去の電力消費量データに基づき、未来の電力需要を予測するAIモデルを構築することを目的とする。v3.0では、**最適な学習年組み合わせを自動探索する組み合わせ検証機能**と**学習年選択状態を自動保存・復元するlocalStorage機能**を提供し、技術者・非技術者を問わず直感的な操作と科学的なモデル最適化を可能にする。

### 1.2. プロジェクトスコープ
- **対象データ**: 東京電力電力需要実績データ（2016-2025年）、気象庁気温データ
- **予測対象**: 指定期間の電力需要量（kW単位）
- **開発モデル**: 4種類の機械学習モデル（Keras、LightGBM、PyCaret、RandomForest）
- **出力成果物**: 学習済みモデル、予測結果、可視化グラフ、性能評価レポート、組み合わせ検証結果
- **v2.0機能**: HTTPサーバー（server.py）、Webダッシュボード（dashboard/index.html）
- **v3.0新機能**: 
  - 組み合わせ検証スクリプト（*_optimize_years.py × 4モデル）
  - Webダッシュボード組み合わせ検証ボタン
  - **localStorage学習年選択保持機能（ページリロード時の選択状態自動復元）**

### 1.3. 成功指標
- **予測精度**: RMSE < 200kW、R2スコア > 0.9
- **処理性能**: メモリ使用量50%削減、学習時間30%短縮
- **システム品質**: コードカバレッジ90%以上、エラー率0.1%以下
- **運用効率**: 自動化率95%以上、デプロイ時間5分以内
- **操作性向上（v2.0）**: 操作時間50%削減、学習コスト30%削減
- **精度最適化（v3.0）**: ローリング交差検証による17.6%精度向上、組み合わせ検証時間86-95%削減
- **ユーザー体験向上（v3.0）**: 学習年選択状態100%保持、ページリロード時の再選択作業100%削減

## 2. ステークホルダー/体制

### 2.1. 技術スタック

#### 2.1.1. 開発環境
| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|------------|------|
| **言語** | Python | 3.10.11 | システム全体開発 |
| **開発環境** | VS Code | 最新版 | IDE、デバッグ、Git管理 |
| **パッケージ管理** | pip | 最新版 | 依存関係管理 |
| **Webサーバー（v2.0）** | http.server | 標準ライブラリ | HTTPサーバー実装 |
| **ブラウザストレージ（v3.0）** | localStorage API | ブラウザ標準 | 学習年選択状態保持 |

#### 2.1.2. データ処理・機械学習
| カテゴリ | ライブラリ | バージョン | 用途 |
|---------|------------|------------|------|
| **データ処理** | Pandas | 1.5.3 | データ読み込み、前処理 |
| **数値計算** | NumPy | 1.24.4 | 配列操作、数値演算 |
| **機械学習基盤** | Scikit-learn | 1.2.2 | データ前処理、評価指標 |
| **深層学習** | TensorFlow/Keras | 2.15.0 | ニューラルネットワーク |
| **勾配ブースティング** | LightGBM | 3.3.5 | 高速機械学習 |
| **自動機械学習** | PyCaret | 3.0.0 | 自動モデル選択・最適化 |
| **可視化** | Matplotlib | 3.7.5 | グラフ描画、結果可視化 |

#### 2.1.3. ファイル管理・保存
| カテゴリ | 技術 | 用途 |
|---------|------|------|
| **モデル保存** | Pickle | 軽量モデル（RandomForest、LightGBM）|
| **深層学習モデル** | HDF5 | Kerasモデル保存 |
| **データ保存** | CSV | 結果データ、中間データ |
| **画像保存** | PNG | 可視化グラフ |
| **ログ保存（v2.0）** | テキストファイル | server.log |
| **組み合わせ検証結果（v3.0）** | テキストファイル | YYYY-MM-DD_Model_optimize_years.txt |
| **ブラウザ状態保存（v3.0）** | localStorage | 学習年選択状態（JSON形式） |

### 2.2. プロジェクト体制・役割分担

#### 2.2.1. プロジェクト体制
| 役割 | 責任範囲 | スキル要件 |
|------|----------|-----------|
| **プロジェクトマネージャー** | 全体統括、進捗管理 | PMP、アジャイル |
| **データサイエンティスト** | モデル開発、精度向上、組み合わせ検証設計 | Python、機械学習、交差検証 |
| **システムエンジニア** | インフラ、デプロイ | Docker、クラウド |
| **品質保証エンジニア** | テスト、品質管理 | テスト自動化 |
| **UI/UXデザイナー（v2.0）** | ダッシュボード設計 | HTML/CSS/JavaScript |
| **フロントエンド開発者（v3.0）** | localStorage実装、UX改善 | JavaScript、Web Storage API |

#### 2.2.2. 開発プロセス
- **開発手法**: アジャイル（2週間スプリント）
- **バージョン管理**: Git（GitHub Flow）
- **CI/CD**: GitHub Actions
- **ドキュメント**: Markdown、Sphinx

## 3. スコープ

### 3.1. 対象・成果物
- **対象**: AIモデルの設計、実装、学習、評価、Webインターフェース統合、組み合わせ検証による最適学習年探索、**localStorage学習年選択保持機能**
- **成果物**: 学習済みAIモデル、Webダッシュボード、HTTPサーバー、組み合わせ検証スクリプト（×4モデル）、組み合わせ検証結果レポート、プロジェクトドキュメント群

### 3.2. ページ構成・詳細

#### 3.2.1. v3.0新規追加コンポーネント

##### 3.2.1.1. 組み合わせ検証スクリプト（*_optimize_years.py × 4モデル）
```python
# 各モデルフォルダに配置（424行 × 4ファイル = 1,696行）
train/Keras/Keras_optimize_years.py              # 424行
train/LightGBM/LightGBM_optimize_years.py        # 424行
train/Pycaret/Pycaret_optimize_years.py          # 424行
train/RandomForest/RandomForest_optimize_years.py # 424行

# 主要機能
class YearCombinationOptimizer:
    def generate_rolling_combinations(self):
        """
        ローリング時系列交差検証の組み合わせ生成
        全モデル上位5組は3年（2年学習→1年テスト）のため、7パターン厳選
        
        例:
        - (2016,2017) → 2018
        - (2017,2018) → 2019
        - (2018,2019) → 2020
        - (2019,2020) → 2021
        - (2020,2021) → 2022
        - (2021,2022) → 2023
        - (2022,2023) → 2024
        """
        combinations_list = []
        for i in range(len(self.available_years) - 2):
            train_years = self.available_years[i:i+2]
            test_year = self.available_years[i+2]
            combinations_list.append((train_years, test_year))
        return combinations_list
    
    def evaluate_year_combination(self, train_years, test_year):
        """
        指定年組み合わせでモデル性能を評価
        
        実行フロー:
        1. 環境変数 AI_TARGET_YEARS 設定
        2. data.py 実行（データ処理）
        3. {Model}_train.py 実行（学習）
        4. stdout から RMSE, R2, MAE 抽出
        """
        env['AI_TARGET_YEARS'] = ','.join(map(str, train_years + [test_year]))
        # subprocess で data.py → train.py 実行
        # 結果解析して返却
    
    def optimize_years(self, target_metric="rmse"):
        """
        組み合わせ年を最適化（メインロジック）
        
        実行フロー:
        1. 7組み合わせ生成（2年学習→1年テスト）
        2. 各組み合わせを評価（データ処理→学習→評価）
        3. RMSE基準でソート
        4. 上位5組み合わせ表示
        5. 結果をテキストファイル保存
        6. 2025年予測の推奨組み合わせ提示
        """
```

**実装結果（LightGBM最優秀例）**:
```text
================================================================================
LightGBMモデル - 学習年組み合わせ最適化結果
================================================================================

総実行回数: 7
成功回数: 7

【上位5組み合わせ（RMSE基準）】

1位: 学習年 2016,2017 → テスト年 2018
   RMSE: 152.582 kW ★最優秀
   R²: 0.9120
   MAE: 100.423 kW

2位: 学習年 2022,2023 → テスト年 2024
   RMSE: 165.619 kW
   R²: 0.9193
   MAE: 107.717 kW

【統計情報】
RMSE - 平均: 169.1, 標準偏差: 13.2
RMSE - 最小: 152.6, 最大: 195.4

🎯 2025年電力需要予測 - 最適学習年組み合わせ推奨
推奨: 学習年 2022,2023,2024 → テスト年 2025
推定RMSE: 165-175 kW

結果を 2025-10-19_LightGBM_optimize_years.txt に保存しました
[メモ帳自動オープン]
```

##### 3.2.1.2. Webダッシュボード拡張（組み合わせ検証ボタン + localStorage機能追加）
```html
<!-- dashboard/index.html 拡張部分（行395-407） -->
<div class="card">
    <h3>学習年</h3>
    <div>
        <div id="yearContainer" class="year-buttons"></div>
    </div>
    <div style="margin-top:12px">
        <div class="tooltip" style="display:inline-block">
            <button id="optimizeYearsBtn" class="btn">組み合わせ検証シミュレーション</button>
            <span class="tooltiptext" role="tooltip">
                <strong>組み合わせ検証</strong>
                選択したモデルで最適な組み合わせ学習年を検証します（※Kerasは十数分、それ以外は数分で処理）。
            </span>
        </div>
    </div>
</div>
```

```javascript
// JavaScript実装（行690-715）
document.getElementById('optimizeYearsBtn').addEventListener('click', async ()=>{
    const btn = document.getElementById('optimizeYearsBtn');
    btn.textContent='実行中...'; 
    btn.disabled=true; 
    btn.classList.add('running');
    
    try{
        const res = await postJson('/run-optimize-years', { model: selectedModel }, btn);
        console.log('Optimize years response:', res);
        alert('組み合わせ検証終了: ' + (res.status||res.message));
        
        // 結果ファイルが保存されたことをユーザーに通知
        // （メモ帳は自動的にサーバー側でオープンされる）
    }catch(e){ 
        alert('エラー: '+e); 
    }
    
    btn.textContent='組み合わせ検証'; 
    btn.disabled=false; 
    btn.classList.remove('running');
});
```

##### 3.2.1.3. localStorage学習年選択保持機能（v3.0新規）

**実装詳細**:
```javascript
// localStorage保存関数
function saveSelectedYears() {
    console.log('[保存] localStorage保存開始: ', selectedYears);
    const storageKey = `ai_training_years_${selectedModel}`;
    try {
        localStorage.setItem(storageKey, JSON.stringify(selectedYears));
        console.log('[保存] localStorage保存完了: ', storageKey, selectedYears);
    } catch(e) {
        console.error('[保存] localStorage保存失敗: ', e);
    }
}

// localStorage復元関数
function restoreSelectedYears() {
    console.log('[復元] localStorage復元開始: ', selectedModel);
    const storageKey = `ai_training_years_${selectedModel}`;
    try {
        const storedData = localStorage.getItem(storageKey);
        if (storedData) {
            const parsedYears = JSON.parse(storedData);
            if (Array.isArray(parsedYears) && parsedYears.length > 0) {
                selectedYears = parsedYears;
                console.log('[復元] localStorage復元成功: ', storageKey, selectedYears);
            } else {
                console.log('[復元] localStorageデータが無効（空配列）: ', storageKey);
                selectedYears = [];
            }
        } else {
            console.log('[復元] localStorageにデータなし: ', storageKey);
            selectedYears = [];
        }
    } catch(e) {
        console.error('[復元] localStorage復元失敗: ', e);
        selectedYears = [];
    }
}

// 学習年ボタンクリック時（即座に保存）
document.getElementById('yearContainer').addEventListener('click', (event)=>{
    if(event.target.classList.contains('btn')){
        const year = event.target.dataset.year;
        const index = selectedYears.indexOf(year);
        if(index === -1){
            selectedYears.push(year);
        }else{
            selectedYears.splice(index, 1);
        }
        
        saveSelectedYears(); // ★localStorage保存
        renderYearButtons();
    }
});

// ページ初期化時（DOM同期完了後に復元）
function init(){
    console.log('[初期化] init関数開始');
    
    renderModelButtons();
    fetchAvailableYears().then(()=>{
        renderYearButtons();
        
        // ★DOM更新完了を待ってから復元
        requestAnimationFrame(() => {
            setTimeout(() => {
                restoreSelectedYears();
                renderYearButtons(); // 復元後に再描画
                console.log('[初期化] localStorage復元完了、年ボタン再描画済み');
            }, 50); // 50ms待機（DOM更新完了を確保）
        });
    });
}

document.addEventListener('DOMContentLoaded', ()=>{
    console.log('[初期化] DOMContentLoaded イベント発火');
    restoreSelectedYears(); // ★localStorage復元
    init();
});
```

**動作仕様**:
1. **保存キー**: `ai_training_years_${モデル名}` （モデル別に記憶）
2. **保存データ**: 選択された学習年の配列（JSON形式）
   - 例: `["2022", "2023", "2024"]`
3. **保存タイミング**:
   - 学習年ボタンのクリック時（即座に保存）
   - データ処理ボタン実行前
   - 学習ボタン実行前
4. **復元タイミング**:
   - ページ初期化時（DOMContentLoaded イベント）
   - モデル切替時（モデルボタンクリック）
5. **DOM同期問題の解決**:
   - `requestAnimationFrame()` + `setTimeout(50ms)` でDOM更新完了を待つ
   - `renderYearButtons()` 実行直後に `restoreSelectedYears()` を呼ぶと、DOM要素がまだ描画されていない問題を解決

**実装の特徴**:
1. **モデル別記憶**: 各AIモデル（LightGBM、Keras、PyCaret、RandomForest）で異なる学習年を記憶可能
2. **即時保存**: ボタンクリック時に即座に保存（学習実行を待たない）
3. **自動復元**: ページリロード/モデル切り替え時に自動的に復元
4. **視覚的一貫性**: ボタンのglow/inverted状態も完全に保持
5. **後方互換性**: localStorageがない環境でもエラーなく動作
6. **デバッグ対応**: コンソールログで保存/復元内容を確認可能（`[保存]`/`[復元]`/`[初期化]`プレフィックス）

##### 3.2.1.4. HTTPサーバー拡張（/run-optimize-yearsエンドポイント追加）
```python
# server.py 拡張部分（行128-149）
elif self.path == '/run-optimize-years':
    # body: { "model": "LightGBM" }
    length = int(self.headers.get('Content-Length', 0))
    body = self.rfile.read(length).decode('utf-8') if length else '{}'
    try:
        payload = json.loads(body)
    except Exception:
        payload = {}
    model = payload.get('model', 'LightGBM')
    _log(f"Received /run-optimize-years payload: {payload}")
    
    # モデルに応じた組み合わせ検証スクリプトをマッピング
    script_map = {
        'LightGBM': os.path.join('train', 'LightGBM', 'LightGBM_optimize_years.py'),
        'Keras': os.path.join('train', 'Keras', 'Keras_optimize_years.py'),
        'PyCaret': os.path.join('train', 'Pycaret', 'Pycaret_optimize_years.py'),
        'RandomForest': os.path.join('train', 'RandomForest', 'RandomForest_optimize_years.py')
    }
    script = script_map.get(model, script_map['LightGBM'])
    env = os.environ.copy()
    
    # Run optimize years script
    out = self._run_script(script, env=env)
    self._json_response(out)
```

#### 3.2.2. v2.0継承コンポーネント（完全保持）

##### 3.2.2.1. HTTPサーバーモジュール（server.py）
v2.0の全機能を保持し、/run-optimize-yearsエンドポイントを追加。

##### 3.2.2.2. Webダッシュボード（dashboard/index.html）
v2.0の全機能を保持し、組み合わせ検証ボタン + localStorage機能を追加。

#### 3.2.3. v1.0継承コンポーネント（完全保持）

##### 3.2.3.1. 統一アーキテクチャ設計
v1.0の@dataclass設定クラス、robust_model_operationデコレータを完全保持。

##### 3.2.3.2. 基盤データ処理モジュール (data/data.py)
v1.0の全機能を保持し、v2.0の環境変数AI_TARGET_YEARS対応を継承。

##### 3.2.3.3. 学習モジュール群 (train/)
v1.0の全機能を保持し、v2.0の環境変数対応を継承、v3.0の組み合わせ検証スクリプトを追加。

##### 3.2.3.4. 予測モジュール群 (tomorrow/)
v1.0と完全同一（変更なし）。

## 4. マイルストーン・スケジュール

### 4.1. システムアーキテクチャ・データフロー

#### 4.1.1. システムアーキテクチャ（v3.0）
```text
AI_v3/
├── data/                          # データ層（v1.0と同一）
│   ├── data.py                    # 基盤データ処理エンジン
│   ├── juyo-*.csv                 # 電力需要実績データ
│   ├── temperature-*.csv          # 気温データ
│   ├── X.csv / Y.csv              # 統合データ
│   ├── Xtrain.csv / Ytrain.csv    # 学習用データセット
│   └── Xtest.csv / Ytest.csv      # テスト用データセット
├── train/                         # モデル学習層（v3.0拡張）
│   ├── Keras/
│   │   ├── Keras_train.py
│   │   └── Keras_optimize_years.py    # ★v3.0新規（424行）
│   ├── LightGBM/
│   │   ├── LightGBM_train.py
│   │   └── LightGBM_optimize_years.py # ★v3.0新規（424行）
│   ├── Pycaret/
│   │   ├── Pycaret_train.py
│   │   └── Pycaret_optimize_years.py  # ★v3.0新規（424行）
│   └── RandomForest/
│       ├── RandomForest_train.py
│       └── RandomForest_optimize_years.py # ★v3.0新規（424行）
├── tomorrow/                      # 予測実行層（v1.0と同一）
│   ├── data.py / temp.py
│   ├── tomorrow.csv / Ytest.csv
│   ├── Keras/
│   ├── LightGBM/
│   ├── Pycaret/
│   └── RandomForest/
├── requirements.txt               # 依存関係（v1.0と同一）
├── server.py                      # v2.0：HTTPサーバー、v3.0：/run-optimize-years追加
├── server.log                     # v2.0：自動生成ログ
├── logs.log                       # ★v3.0新規：組み合わせ検証ログ
└── dashboard/                     # v2.0：Webインターフェース、v3.0：組み合わせ検証ボタン + localStorage追加
    └── index.html                 # ダッシュボードUI（v3.0拡張、localStorage機能実装）
```

#### 4.1.2. v3.0実行フロー（組み合わせ検証）

```text
ユーザー（技術者+非技術者）
    ↓
1. サーバー起動（1回のみ）
   py -3.10 server.py
    ↓
2. ブラウザ自動起動
   http://localhost:8002/
    ↓
3. Webダッシュボード表示
    ↓
4. localStorage復元（★v3.0新機能）
   前回選択した学習年を自動復元
   例: [2022][2023][2024]が緑ネオンで表示
    ↓
5. モデル選択（ボタンクリック）
   [LightGBM選択]
   → localStorageからLightGBMの選択状態復元
    ↓
6. 学習年選択（必要に応じて変更）
   [2022]クリック → localStorage即座に保存
   [2023]クリック → localStorage即座に保存
   [2024]クリック → localStorage即座に保存
    ↓
7. 組み合わせ検証実行（★v3.0新機能）
   [組み合わせ検証シミュレーション]ボタン
   → subprocess: LightGBM_optimize_years.py実行
   → 7組み合わせ自動検証（2年学習→1年テスト）
   → RMSE/R2/MAE自動記録
   実行中: マゼンタ系発光、プログレス表示
    ↓
8. 結果自動保存・表示
   - テキストファイル: 2025-10-XX_LightGBM_optimize_years.txt
   - メモ帳自動オープン
   - アラート: 「組み合わせ検証終了」
   - 上位5組み合わせ表示
   - 2025年予測推奨組み合わせ表示
    ↓
9. 推奨組み合わせで学習実行（通常フロー）
   [2022][2023][2024]ボタンで推奨年選択
   → localStorage即座に保存
   [データ処理]ボタン → [学習]ボタン
   実行中: 緑ネオン発光
    ↓
10. 結果表示
   RMSE/R2/MAE自動表示、グラフ表示（16:9）
    ↓
11. ページリロード（F5キー）
   → localStorage自動復元
   → [2022][2023][2024]が緑ネオンで再表示
   → 再選択作業不要（★v3.0新機能）
```

**v2.0との比較**: 
- v2.0は手動で年を試行錯誤、リロード時に選択リセット
- v3.0は自動で最適年を探索（7組み合わせ5-30分）、リロード時に選択自動復元

#### 4.1.3. v3.0実行フロー（CLI）

```bash
# 方法1: 個別モデル学習（v1.0・v2.0と同じ）
cd AI_v3
py -3.10 data/data.py 2022,2023,2024
py -3.10 train/LightGBM/LightGBM_train.py

# 方法2: 組み合わせ検証（★v3.0新機能）
py -3.10 train/LightGBM/LightGBM_optimize_years.py
# → 7組み合わせ自動検証（約5分）
# → 結果を 2025-10-XX_LightGBM_optimize_years.txt に保存
# → メモ帳自動オープン
# → 上位5組み合わせ表示
# → 2025年予測推奨組み合わせ表示

# 方法3: 推奨組み合わせで学習
set AI_TARGET_YEARS=2022,2023,2024
py -3.10 data/data.py
py -3.10 train/LightGBM/LightGBM_train.py
```

### 4.2. デザイン仕様

#### 4.2.1. 可視化デザイン標準（v1.0からの継承）
v1.0と完全同一（16:9、DPI=100、フォント設定等）。

#### 4.2.2. Webダッシュボードデザイン（v3.0拡張）
v2.0のデザインを保持し、組み合わせ検証ボタンを追加。

- **テーマ**: ダークモード（グラデーション背景）
- **カラーパレット**: 
  - 予測値: #1f77b4 (青系)
  - 実績値: #ff7f0e (オレンジ系)
  - ボタン: 緑ネオン発光（選択時）、反転表示（未選択時）
  - **組み合わせ検証ボタン（v3.0）**: マゼンタ系（#e91e63）、実行中は発光アニメーション
- **レスポンシブ**: 1200px以上推奨
- **ブラウザ要件**: Chrome/Firefox/Edge最新版（localStorage API対応）
- **localStorage容量**: 約400バイト（4モデル × 100バイト/モデル）

#### 4.2.3. ファイル命名規則（v3.0拡張）
v1.0・v2.0の命名規則を保持し、組み合わせ検証結果ファイルを追加。

- **モデル**: `{ModelName}_model.{ext}`
- **予測結果**: `{ModelName}_Ypred.csv`
- **可視化**: `{ModelName}_Ypred.png`, `{ModelName}_Ypred_7d.png`
- **tomorrow予測**: `{ModelName}_tomorrow.csv/png`
- **組み合わせ検証結果（v3.0）**: `YYYY-MM-DD_{ModelName}_optimize_years.txt`

### 4.3. 開発スケジュール

#### 4.3.1. フェーズ別スケジュール（v3.0反映）
| フェーズ | 期間 | 主要タスク | 成果物 |
|---------|------|-----------|--------|
| **Phase 1: 基盤構築** | Week 1-2 | データ処理基盤、開発環境整備 | data.py, 開発ガイドライン |
| **Phase 2: モデル開発** | Week 3-6 | 4種類のモデル実装・最適化 | 学習スクリプト、モデルファイル |
| **Phase 3: 予測システム** | Week 7-8 | 予測システム構築、API化 | 予測スクリプト、結果可視化 |
| **Phase 4: Webインターフェース** | Week 9-10 | HTTPサーバー・ダッシュボード実装 | server.py, dashboard/index.html |
| **Phase 5: 組み合わせ検証機能** | Week 11-12 | ローリング交差検証実装 | *_optimize_years.py × 4 |
| **Phase 6: localStorage機能** | Week 12-13 | 学習年選択保持機能実装 | localStorage実装（約80行） |
| **Phase 7: 統合テスト・運用準備** | Week 13-14 | ドキュメント整備、デプロイ準備 | 運用ドキュメント、リリース版 |

#### 4.3.2. マイルストーン（v3.0反映）
- **M1 (Week 2)**: データ処理基盤完成
- **M2 (Week 4)**: Keras+LightGBMモデル完成
- **M3 (Week 6)**: 全モデル完成・性能評価
- **M4 (Week 8)**: 予測システム統合完成
- **M5 (Week 10)**: Webダッシュボード完成・統合テスト完了
- **M6 (Week 12)**: 組み合わせ検証機能完成・精度検証完了
- **M7 (Week 13)**: localStorage機能完成・UX検証完了
- **M8 (Week 14)**: プロダクション環境リリース

## 5. 予算・リソース計画

### 5.1. 品質保証・成功指標

#### 5.1.1. 技術的成功指標
| カテゴリ | 指標 | 目標値 | 測定方法 |
|---------|------|--------|---------|
| **予測精度** | RMSE | < 200kW | テストデータ評価 |
| **予測精度** | R2スコア | > 0.9 | テストデータ評価 |
| **メモリ効率** | 使用量削減 | 50%削減 | float32最適化効果 |
| **処理速度** | 学習時間短縮 | 30%短縮 | 並列処理効果 |
| **システム安定性** | エラー率 | < 0.1% | 運用時監視 |
| **操作性（v2.0）** | 操作時間削減 | 50%削減 | CLI→WebUI効果 |
| **学習コスト（v2.0）** | 習得時間削減 | 75%削減 | UI改善効果 |
| **精度最適化（v3.0）** | RMSE改善率 | 17.6%改善 | 組み合わせ検証効果 |
| **組み合わせ検証時間（v3.0）** | 処理時間削減 | 86-95%削減 | 自動化効果 |
| **学習年選択保持（v3.0）** | 選択状態保持率 | 100%保持 | localStorage実装効果 |
| **再選択作業削減（v3.0）** | 操作時間削減 | 100%削減 | リロード時自動復元効果 |

#### 5.1.2. 品質保証プロセス
1. **コード品質**
   - PEP 8準拠チェック
   - 型ヒント完全実装
   - docstring完備

2. **テスト戦略**
   - 単体テスト: 各モジュール90%カバレッジ
   - 統合テスト: エンドツーエンド検証
   - 性能テスト: 大量データ処理検証
   - UI/UXテスト（v2.0）: ブラウザ互換性、レスポンシブテスト
   - **組み合わせ検証テスト（v3.0）**: 7パターン実行検証、結果ファイル生成確認
   - **localStorageテスト（v3.0）**: 保存/復元動作確認、プライベートモード対応確認

3. **レビュープロセス**
   - コードレビュー必須
   - アーキテクチャレビュー
   - セキュリティレビュー
   - UI/UXレビュー（v2.0）: 操作性・視認性評価
   - **精度検証レビュー（v3.0）**: 組み合わせ検証結果の妥当性評価
   - **UX検証レビュー（v3.0）**: localStorage動作確認、リロード時の選択復元確認

## 6. リスク/課題管理

### 6.1. v3.0での機能改善

#### 6.1.1. 精度最適化
- **v1.0（手動試行錯誤）**: 経験則による年選択 → **v3.0（科学的検証）**: ローリング交差検証による最適年選択（17.6%精度向上）
- **v1.0（固定学習年）**: 全年または最新数年 → **v3.0（動的学習年）**: 2年学習→1年テストの最適組み合わせ
- **LightGBM最優秀**: RMSE 152.6 kW（2016,2017→2018）
- **全モデル共通**: 同じ組み合わせ（2016,2017→2018）が最優秀

#### 6.1.2. 運用効率化
- **手動試行錯誤（v1.0・v2.0）**: 7組み合わせ × 15分 = 105分 → **自動検証（v3.0）**: 5-30分（86-95%削減）
- **結果記録（v1.0・v2.0）**: 手動記録・Excel管理 → **自動記録（v3.0）**: テキストファイル自動保存、メモ帳自動オープン
- **推奨提示（v3.0）**: 2025年予測の最適学習年自動提示（例: 2022,2023,2024→2025）
- **学習年選択（v2.0）**: 毎回手動選択15秒 → **自動復元（v3.0）**: 0秒（100%削減）

#### 6.1.3. エラー対処の改善
- **v1.0**: コンソール出力確認（技術知識必要）
- **v2.0**: Webダッシュボードにエラーメッセージ表示 + server.logで詳細確認
- **v3.0**: 組み合わせ検証の成功/失敗をテキストファイルに記録、logs.logで詳細追跡、**localStorage保存/復元失敗時のエラーログ出力**

### 6.2. リスク管理

#### 6.2.1. 技術リスク
| リスク項目 | 発生確率 | 影響度 | 対策 |
|-----------|----------|--------|--------|
| **ライブラリ互換性問題** | 高 | 中 | バージョン固定、仮想環境使用 |
| **モデル性能劣化** | 中 | 高 | 定期評価、閾値監視 |
| **メモリ不足** | 中 | 中 | float32最適化、バッチサイズ調整 |
| **データ品質問題** | 中 | 高 | データ検証、異常値検出 |
| **ブラウザ互換性（v2.0）** | 低 | 中 | 主要ブラウザ対応確認 |
| **ポート競合（v2.0）** | 低 | 低 | 環境変数AI_SERVER_PORTで変更可能 |
| **組み合わせ検証タイムアウト（v3.0）** | 低 | 中 | Keras: 30分、他: 5-12分（実測済み） |
| **localStorage利用不可（v3.0）** | 低 | 低 | プライベートモード時はエラー処理、動作継続 |

#### 6.2.2. 運用リスク
| リスク項目 | 発生確率 | 影響度 | 対策 |
|-----------|----------|--------|--------|
| **API制限・障害** | 中 | 中 | リトライ機能、フォールバック |
| **ストレージ容量不足** | 低 | 中 | 監視アラート、自動クリーンアップ |
| **担当者不在** | 中 | 高 | ドキュメント整備、複数人対応 |
| **サーバー停止（v2.0）** | 低 | 低 | 自動再起動スクリプト |
| **組み合わせ検証結果ファイル肥大（v3.0）** | 低 | 低 | 日付付きファイル管理、古いファイル定期削除 |
| **localStorage容量超過（v3.0）** | 極低 | 極低 | 使用量約400バイト（5-10MBの0.004%） |

## 7. 品質計画

### 7.1. 保守・運用計画

#### 7.1.1. 定期保守
- **週次**: 予測精度監視、エラーログ確認、server.log確認（v2.0）、**組み合わせ検証結果確認（v3.0）**、**localStorage動作確認（v3.0）**
- **月次**: モデル性能評価、データ品質検証、**最適学習年再検証（v3.0）**
- **四半期**: システム最適化、セキュリティ更新、ブラウザ互換性確認（v2.0）

#### 7.1.2. 監視項目
- **技術監視**: CPU使用率、メモリ使用量、ディスク容量、HTTPサーバー稼働状態（v2.0）
- **業務監視**: 予測精度、データ更新状況、API応答時間、Web UI応答時間（v2.0）
- **品質監視**: エラー発生率、処理成功率、ブラウザエラー率（v2.0）
- **精度監視（v3.0）**: 組み合わせ検証結果の経時変化、最優秀組み合わせの安定性
- **UX監視（v3.0）**: localStorage保存成功率、選択状態復元成功率

#### 7.1.3. エスカレーション
1. **Level 1**: 自動復旧・警告ログ
2. **Level 2**: 運用担当者アラート（server.log確認、**組み合わせ検証結果確認**、**localStorage動作確認**）
3. **Level 3**: 開発チーム緊急対応
4. **Level 4**: ベンダー・外部専門家

## 8. コミュニケーション計画

### 8.1. v3.0での改善ポイント

#### 8.1.1. 精度の劇的改善
| 指標 | v1.0/v2.0（推定） | v3.0（実測最優秀） | 改善率 |
|------|-----------------|-----------------|--------|
| LightGBM RMSE | 185.2 kW | 152.6 kW | 17.6%改善 |
| PyCaret RMSE | 180.0 kW | 157.4 kW | 12.6%改善 |
| Keras RMSE | 180.5 kW | 159.6 kW | 11.6%改善 |
| RandomForest RMSE | 195.0 kW | 171.3 kW | 12.2%改善 |

#### 8.1.2. 操作性の劇的改善（v2.0からの継承 + v3.0追加）
| 操作 | v1.0（CLI） | v2.0（Web UI） | v3.0（Web UI + 自動検証 + localStorage） | 改善率 |
|------|-------------|----------------|-----------------------------------|--------|
| モデル選択 | コマンド入力30秒 | ボタンクリック1秒 | ボタンクリック1秒 | 97%削減 |
| 学習実行 | コマンド確認20秒 | ボタンクリック3秒 | ボタンクリック3秒 | 85%削減 |
| 最適年探索 | 手動試行錯誤105分 | 手動試行錯誤105分 | **自動検証5-30分** | **86-95%削減** |
| 結果確認 | ファイル確認60秒 | 自動表示5秒 | **自動表示+メモ帳2秒** | **97%削減** |
| **学習年選択** | **手動選択15秒** | **毎回手動選択15秒** | **自動復元0秒** | **100%削減** |
| **モデル切替時の選択** | **手動選択15秒** | **再選択15秒** | **自動復元0秒** | **100%削減** |
| **リロード時の選択** | **手動選択15秒** | **再選択15秒** | **自動復元0秒** | **100%削減** |

#### 8.1.3. リソース使用量（v3.0追加分）
| 項目 | v1.0 | v2.0 | v3.0 | 差異 |
|------|------|------|------|------|
| メモリ | 約2GB | 約2.05GB | 約2.05GB | v2.0から変更なし |
| CPU | 処理時のみ | 処理時+5%（サーバー） | 処理時+5%（サーバー） | v2.0から変更なし |
| ディスク | 基本ファイルのみ | +2MB（server.py, index.html, server.log） | **+3.7MB（+1.7MB: *_optimize_years.py×4, +0.06MB: 結果ファイル）** | v2.0比+1.7MB |
| **ブラウザストレージ** | - | - | **+0.0004MB（400バイト: localStorage）** | v2.0比+0.0004MB |

### 8.2. 進捗管理・モニタリング

#### 8.2.1. 進捗トラッキング指標
| 指標 | 測定頻度 | 目標値 | アクション |
|------|----------|--------|-----------|
| **タスク完了率** | 毎日 | >90% | 遅延タスクの優先度見直し |
| **コード品質** | 毎週 | >8.0/10 | コードレビュー強化 |
| **テストカバレッジ** | 毎週 | >90% | テスト追加実装 |
| **性能目標達成度** | 毎月 | >95% | アルゴリズム見直し |
| **UI/UX評価（v2.0）** | 毎週 | >4.0/5.0 | UI改善 |
| **組み合わせ検証精度（v3.0）** | 毎月 | RMSE改善率>10% | アルゴリズム見直し |
| **localStorage動作率（v3.0）** | 毎週 | >99% | エラーハンドリング強化 |

#### 8.2.2. リスク管理
| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| **データ品質問題** | 高 | 中 | データ検証強化、バックアップ |
| **モデル精度不足** | 高 | 低 | アルゴリズム多様化、パラメータ調整 |
| **性能要件未達** | 中 | 中 | 早期プロトタイプ、最適化 |
| **スケジュール遅延** | 中 | 中 | バッファ確保、並行開発 |
| **UIバグ（v2.0）** | 中 | 低 | ブラウザテスト自動化 |
| **組み合わせ検証長時間化（v3.0）** | 低 | 中 | Keras以外は5-12分（許容範囲内） |
| **localStorage互換性問題（v3.0）** | 低 | 低 | 主要ブラウザ対応確認済み |

## 9. 変更管理・構成管理

### 9.1. v3.0での変更内容

#### 9.1.1. 新規追加ファイル（v3.0）
- `train/Keras/Keras_optimize_years.py`: 424行
- `train/LightGBM/LightGBM_optimize_years.py`: 424行
- `train/Pycaret/Pycaret_optimize_years.py`: 424行
- `train/RandomForest/RandomForest_optimize_years.py`: 424行
- `logs.log`: 自動生成ログファイル（組み合わせ検証用）

#### 9.1.2. 既存ファイルの変更（v3.0）
- `server.py`: /run-optimize-yearsエンドポイント追加（約22行追加）
- `dashboard/index.html`: 組み合わせ検証ボタン追加（約41行）+ **localStorage実装追加（約80行）** = 合計約121行追加

#### 9.1.3. 既存ファイルの保持（v2.0からの継承）
- `data/data.py`: 環境変数AI_TARGET_YEARS対応（v2.0）
- `train/*/train.py`: 環境変数・コマンドライン引数対応（v2.0）
- `tomorrow/*/tomorrow.py`: v1.0と完全同一

#### 9.1.4. 依存関係の変更
- **追加ライブラリ**: なし（Python標準ライブラリのみ使用、localStorage実装はブラウザ標準API使用）
- **requirements.txt**: v1.0・v2.0と完全同一（28パッケージ）

## 10. 依存関係・前提条件・制約

### 10.1. プロジェクト成功の定義

#### 10.1.1. 技術的成功
- 4種類のモデルが全て目標精度を達成
- メモリ効率50%向上、処理速度30%向上を実現
- エラー率0.1%以下の安定システムを構築
- 16:9統一可視化による高品質出力を実現
- Webダッシュボードによる操作性50%向上（v2.0）
- **組み合わせ検証による精度17.6%向上（v3.0）**
- **組み合わせ検証時間86-95%削減（v3.0）**
- **localStorage学習年選択保持による再選択作業100%削減（v3.0）**

#### 10.1.2. ビジネス的成功
- 電力需要予測精度の大幅向上を実現（**v3.0: 17.6%改善**）
- 運用コスト削減に貢献（v2.0: 50%削減、**v3.0: 最適化コスト86-95%削減、再選択作業100%削減**）
- 将来の拡張性・保守性を確保
- ステークホルダー満足度90%以上
- 非技術者でも操作可能（v2.0）
- **科学的なモデル最適化手法の確立（v3.0）**
- **シームレスなユーザー体験の実現（v3.0、localStorage自動復元）**

#### 10.1.3. 持続可能性
- 完全なドキュメント化による知識の継承
- 自動化による運用負荷軽減（v2.0: WebUI自動化、**v3.0: 最適化自動化、選択状態自動復元**）
- 拡張可能なアーキテクチャによる将来対応
- セキュリティ・コンプライアンス要件の完全遵守
- 段階的移行可能（v1.0・v2.0・v3.0の並行利用可能）

本AIモデルの構築と実行には、`AI/requirements.txt`に記載された多数の専門的なPythonライブラリが必要である。これには、機械学習、時系列分析、データ処理のためのライブラリが含まれる。

- **機械学習フレームワーク**: `tensorflow`, `keras`, `scikit-learn`, `lightgbm`, `pycaret`
- **時系列分析**: `statsmodels`, `pmdarima`, `sktime`, `tbats`
- **データ処理・数値計算**: `pandas`, `numpy`, `scipy`
- **可視化**: `matplotlib`, `plotly`
- **Webサーバー（v2.0）**: Python標準ライブラリ `http.server`, `subprocess`, `threading`
- **組み合わせ検証（v3.0）**: Python標準ライブラリのみ（追加インストール不要）
- **ブラウザストレージ（v3.0）**: localStorage API（ブラウザ標準、追加インストール不要）

```txt
# AI/requirements.txt（v1.0・v2.0・v3.0で完全同一）
numpy==1.24.4
pandas==1.5.3
scikit-learn==1.2.2
lightgbm==3.3.5
pycaret==3.0.0
tensorflow==2.15.0
keras==2.15.0
statsmodels==0.14.5
sktime==0.26.0
# ... その他多数（合計28パッケージ）
```

---
