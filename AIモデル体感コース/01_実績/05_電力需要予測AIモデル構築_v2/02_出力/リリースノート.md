# 電力需要予測AIモデル構築 - リリースノート v2.0

※ この資料は教育用のサンプルです。

## 1. バージョン情報

- **バージョン**: v2.0.0
- **リリース日**: 2025年10月15日
- **リリースタイプ**: メジャーアップデート（Webダッシュボード統合版）
- **前バージョン**: v1.0.0 (2025年10月1日)

### 1.1. システム要件
- **OS**: Windows 10・11（PowerShell対応）
- **Python**: 3.10.11（全モジュール統一バージョン、v1.0と同一）
- **メモリ**: 8GB以上推奨（v1.0: 8GB → v2.0: 8GB、変更なし）
- **ディスク**: 5GB以上空き容量（v1.0と同一）
- **ネットワーク**: インターネット接続（TEPCO・Open-Meteo API、v1.0と同一）
- **ブラウザ（v2.0新規）**: Chrome/Firefox/Edge最新版（Webダッシュボード用）
- **ポート（v2.0新規）**: 8002番（デフォルト、環境変数AI_SERVER_PORTで変更可能）

## 2. リリース日

2025年10月15日

## 3. 変更概要

### 3.1. v2.0の主要変更
v1.0の電力需要予測AIモデル構築システムに、**Webダッシュボード機能を統合**したメジャーアップデートである。v1.0の全機能を100%保持しつつ、**HTTPサーバー**および**ブラウザベースWebインターフェース**を追加し、操作時間50%削減、学習コスト75%削減を実現した非破壊的拡張版である。

#### 3.1.1. 新機能サマリ
- ✅ **HTTPサーバー実装** (server.py、約250行)
- ✅ **Webダッシュボード実装** (dashboard/index.html、約1117行)
- ✅ **環境変数AI_TARGET_YEARS対応** (学習年動的指定)
- ✅ **環境変数AI_SERVER_PORT対応** (ポート番号変更)
- ✅ **server.log自動生成** (全実行履歴記録)
- ✅ **自動ブラウザ起動** (サーバー起動時)
- ✅ **v1.0 CLI完全互換** (下位互換性100%維持)

#### 3.1.2. 改善指標
| 項目 | v1.0実績 | v2.0目標 | v2.0達成値 | 達成率 |
|------|---------|---------|-----------|--------|
| **CLI操作時間** | 30秒 | 50%削減 | 1秒（97%削減） | 194% |
| **結果確認時間** | 60秒 | 50%削減 | 5秒（92%削減） | 184% |
| **モデル切替時間** | 30秒 | 50%削減 | 2秒（93%削減） | 186% |
| **学習コスト** | 2時間 | 75%削減 | 30分（75%削減） | 100% |
| **メモリ追加使用量** | - | +100MB以下 | +50MB（2.4%増） | 50% |

## 4. 追加機能

### 4.1. Webインターフェース機能（v2.0新規）

#### 4.1.1. HTTPサーバー機能 (server.py)
- **ファイルパス**: `AI/server.py`
- **コード行数**: 約250行
- **技術スタック**: Python標準ライブラリのみ（http.server, subprocess, threading）
- **追加ライブラリ**: なし

**主要機能**:
- `ThreadingTCPServer`による並行接続対応（最大10接続）
- subprocessによる既存Pythonスクリプト透過的実行
- 環境変数`AI_TARGET_YEARS`による学習年指定
- 環境変数`AI_SERVER_PORT`によるポート変更（デフォルト: 8002）
- `server.log`への全リクエスト/レスポンス/エラー記録
- 自動ブラウザ起動機能（`webbrowser.open()`）
- 40分タイムアウト設定（長時間学習対応）

**APIエンドポイント**:
| メソッド | パス | 説明 | タイムアウト |
|---------|------|------|------------|
| **POST** | /run-data | データ処理実行 | 40分 |
| **POST** | /run-train | モデル学習実行 | 40分 |
| **POST** | /run-tomorrow-data | 最新データ取得 | 40分 |
| **POST** | /run-tomorrow | 予測実行 | 40分 |
| **GET** | /available-years | 利用可能年一覧取得 | 1秒 |
| **GET** | / | ダッシュボード表示 | 1秒 |

**実装例**:
```python
PORT = int(os.environ.get('AI_SERVER_PORT', '8002'))

class CustomHTTPRequestHandler(http.server.SimpleHTTPRequestHandler):
    def do_POST(self):
        if self.path == '/run-train':
            # 環境変数AI_TARGET_YEARS設定
            env = os.environ.copy()
            env['AI_TARGET_YEARS'] = ','.join(map(str, data['years']))
            
            # subprocess実行
            result = subprocess.run(
                ['python', 'train.py'],
                env=env,
                capture_output=True,
                text=True,
                timeout=2400
            )
```

#### 4.1.2. Webダッシュボード機能 (dashboard/index.html)
- **ファイルパス**: `AI/dashboard/index.html`
- **コード行数**: 約1117行（HTML/CSS/JavaScript統合）
- **技術スタック**: HTML5, CSS3, JavaScript (Fetch API)
- **追加ライブラリ**: なし（純粋Webブラウザ標準機能のみ）

**UI構成**:
```text
┌─────────────────────────────────────┐
│ 電力需要AI予測ダッシュボード v2.0      │
├───────┬───────┬───────┬──────────────┤
│モデル │ 予測  │ 学習  │ 学習年       │
│選択   │カード │カード │カード        │
├───────┴───────┴───────┴──────────────┤
│ 予測グラフエリア  │ 学習グラフエリア│
│ (16:9)         │ (16:9)        │
└────────────────────┴─────────────────┘
```

**主要機能**:
- **4モデル選択ボタン**: Keras/LightGBM/PyCaret/RandomForest
- **ワンクリック実行**: データ処理・学習・予測ボタン
- **リアルタイムグラフ表示**: 16:9アスペクト比統一
- **指標自動表示**: RMSE/R2/MAE自動更新
- **ネオン発光エフェクト**: 選択中モデル強調（緑色ネオン）
- **学習年複数選択**: 2022/2023/2024ボタン（トグル選択）
- **グラフ拡大機能**: モーダルウィンドウ表示
- **ダウンロード機能**: 予測結果PNG保存
- **ツールチップ**: ホバー時の詳細情報表示

**デザイン仕様**:
- **テーマ**: ダークモード（グラデーション背景: #1a1a2e → #16213e）
- **カラーパレット**:
  - 予測値: #1f77b4 (青系)
  - 実績値: #ff7f0e (オレンジ系)
  - ボタン: 緑ネオン発光（選択時: box-shadow: 0 0 30px rgba(76,175,80,0.8)）
- **レスポンシブ**: 1200px以上推奨
- **ブラウザ要件**: Chrome/Firefox/Edge最新版

#### 4.1.3. 環境変数連携機能
**対象ファイル**: `AI/data/data.py`, `AI/train/*/train.py`（5ファイル）

**実装内容**:
```python
import os

# 環境変数からの年取得
target_years_env = os.environ.get('AI_TARGET_YEARS', '')
if target_years_env:
    target_years = [int(y.strip()) for y in target_years_env.split(',')]
    print(f"環境変数AI_TARGET_YEARSから学習年を取得: {target_years}")
    df = df[df['datetime'].dt.year.isin(target_years)]

# コマンドライン引数からの年取得（下位互換性）
import sys
if len(sys.argv) > 1:
    target_years = [int(y) for y in sys.argv[1].split(',')]
    print(f"コマンドライン引数から学習年を取得: {target_years}")
    df = df[df['datetime'].dt.year.isin(target_years)]
```

**特徴**:
- HTTPサーバー経由での動的年指定
- CLI経由での従来型年指定も継続サポート
- 環境変数未設定時はv1.0と完全同一動作（下位互換性100%）

#### 4.1.4. 実行履歴ログ機能 (server.log)
**ファイルパス**: `AI/server.log`（自動生成）
**形式**: プレーンテキスト（UTF-8エンコーディング）

**記録内容**:
- リクエスト受信ログ（タイムスタンプ、HTTPメソッド、パス、パラメータ）
- subprocess実行ログ（コマンド、環境変数、実行時間）
- レスポンスログ（ステータスコード、出力サイズ）
- エラーログ（例外詳細、スタックトレース）

**ログローテーション**: 10MB超過時に自動バックアップ（server.log.1, server.log.2, ...）

### 4.2. v1.0機能（完全保持）

#### 4.2.1. 統合データ処理モジュール (`AI/data/data.py`)
**v2.0拡張**: 環境変数AI_TARGET_YEARS対応追加（約5行追加）
**v1.0機能**: 完全保持（透過的実行）

- 多重ファイル統合処理
- 高度エンコーディング対応
- メモリ最適化（float32）
- 特徴量エンジニアリング
- データ品質保証
- パフォーマンス監視

#### 4.2.2. 4つのAIモデル学習システム
**v2.0拡張**: 全4モデルの学習スクリプトに環境変数AI_TARGET_YEARS対応追加
**v1.0機能**: 完全保持（学習アルゴリズム・パラメータは完全同一）

##### 4.2.2.1. Keras深層ニューラルネットワーク (`AI/train/Keras/`)
- 多層ネットワーク（Dense 64ユニット×複数層）
- 早期停止機能（EarlyStopping, patience=5）
- 学習曲線可視化（16:9）
- StandardScaler正規化
- Adam最適化（learning_rate=0.001）
- 再現性保証（random_seed固定）

##### 4.2.2.2. LightGBM勾配ブースティング (`AI/train/LightGBM/`)
- 高速並列学習（n_jobs=-1）
- 自動パラメータ調整
- メモリ効率処理
- 特徴量重要度分析

##### 4.2.2.3. PyCaret自動機械学習 (`AI/train/Pycaret/`)
- AutoML最適化（20+アルゴリズム比較）
- アンサンブル学習
- 自動特徴量選択
- ハイパーパラメータ自動調整

##### 4.2.2.4. RandomForestアンサンブル (`AI/train/RandomForest/`)
- 複数決定木（100+決定木）
- 並列処理最適化（n_jobs=-1）
- 特徴量重要度分析
- 過学習抑制（max_depth制限）

#### 4.2.3. 翌日予測システム (`AI/tomorrow/`)
**v2.0での変更**: なし（v1.0と完全同一、透過的実行）

##### 4.2.3.1. TEPCO電力データ自動取得 (`tomorrow/data.py`)
- リアルタイム取得
- URLパターン解析
- ZIPファイル展開
- データ形式統一
- エラーハンドリング
- レート制限対応

##### 4.2.3.2. 気温データAPI連携 (`tomorrow/temp.py`)
- Open-Meteo API連携
- JSON解析
- 時系列整合
- API最適化

##### 4.2.3.3. 4モデル翌日予測実行
- Keras予測
- LightGBM予測
- PyCaret予測
- RandomForest予測

#### 4.2.4. 高度可視化・評価システム
**v2.0での変更**: なし（v1.0と完全同一）

- 統一可視化（16:9, 100DPI, PNG）
- 多角的評価（RMSE, MAE, R², MAPE）
- 予測結果保存（CSV, PNG）
- 学習進捗監視
- メモリ使用量監視

#### 4.2.5. 統一アーキテクチャ
**v2.0での変更**: なし（v1.0と完全同一）

- @dataclass設定管理
- robust_model_operationデコレータ
- 型安全性（Type Hints完全実装）
- ログ統一（logging標準ライブラリ）
- ガベージコレクション（gc.collect()）

### 4.3. 技術仕様

#### 4.3.1. 依存関係（28パッケージ、v1.0と完全同一）
**v2.0での変更**: なし（追加ライブラリなし）

```text
# 数値計算基盤
numpy==1.24.4
pandas==1.5.3
scipy==1.11.4

# 機械学習コア
scikit-learn==1.2.2
lightgbm==3.3.5
pycaret==3.0.0
imbalanced-learn==0.10.1
joblib==1.3.2

# 深層学習
tensorflow==2.15.0
tensorflow-intel==2.15.0
keras==2.15.0

# 可視化
matplotlib==3.7.5
plotly==5.24.1
plotly-resampler==0.10.0

# ネットワーク・API
requests==2.32.4
urllib3==2.5.0

# システム監視
psutil==7.0.0

# 時系列分析拡張
pmdarima==2.0.4
statsmodels==0.14.5
tbats==1.1.3
sktime==0.26.0

# データ処理拡張
openpyxl==3.1.5
orjson==3.11.1
pyod==2.0.5
category_encoders==2.7.0

# ユーティリティ
typing-extensions==4.14.1
tqdm==4.67.1
```

**v2.0でのHTTPサーバー実装**: Python標準ライブラリのみ使用（追加インストール不要）
- `http.server`: HTTPサーバー機能
- `subprocess`: Pythonスクリプト実行
- `threading`: 並行接続対応
- `webbrowser`: 自動ブラウザ起動
- `json`: JSONデータ処理
- `urllib.parse`: URLパース処理

#### 4.3.2. ファイル構成（v2.0版）
```text
C:\Users\<UserName>\<project_root>\05_電力需要予測AIモデル構築\
├── AI\                                    # AIモデル実装
│   ├── data\                              # データ前処理
│   │   └── data.py                        # 統合データ処理（614行、v2.0拡張）
│   ├── train\                             # モデル学習
│   │   ├── Keras\Keras_train.py          # Keras学習（649行、v2.0拡張）
│   │   ├── LightGBM\LightGBM_train.py    # LightGBM学習（v2.0拡張）
│   │   ├── Pycaret\Pycaret_train.py      # PyCaret学習（v2.0拡張）
│   │   └── RandomForest\RandomForest_train.py  # RandomForest学習（v2.0拡張）
│   ├── tomorrow\                          # 翌日予測（v1.0と同一）
│   │   ├── data.py                        # TEPCO取得（733行）
│   │   ├── temp.py                        # 気温取得
│   │   ├── Keras\Keras_tomorrow.py       # Keras予測
│   │   ├── LightGBM\LightGBM_tomorrow.py # LightGBM予測
│   │   ├── Pycaret\Pycaret_tomorrow.py   # PyCaret予測
│   │   └── RandomForest\RandomForest_tomorrow.py  # RandomForest予測
│   ├── server.py                          # ★v2.0新規: HTTPサーバー（250行）
│   ├── server.log                         # ★v2.0新規: 実行履歴ログ（自動生成）
│   ├── dashboard\                         # ★v2.0新規: Webダッシュボード
│   │   └── index.html                     # ダッシュボードUI（1117行）
│   └── requirements.txt                   # 依存関係（28パッケージ、v1.0と同一）
├── data\                                  # 学習データ（v1.0と同一）
│   ├── juyo-20xx.csv                     # 電力需要実績
│   └── temperature-20xx.csv              # 気温データ
└── models\                                # 学習済みモデル（v1.0と同一）
    ├── Keras_model.h5                    # Keras保存形式
    ├── LightGBM_model.sav               # LightGBM保存形式
    ├── Pycaret_model.pkl                # PyCaret保存形式
    └── RandomForest_model.sav           # RandomForest保存形式
```

**v2.0新規追加ファイル**:
- `AI/server.py`: HTTPサーバー（約250行、約10KB）
- `AI/dashboard/index.html`: Webダッシュボード（約1117行、約50KB）
- `AI/server.log`: 実行履歴ログ（自動生成、約2MB）

**v2.0拡張ファイル**:
- `AI/data/data.py`: 環境変数AI_TARGET_YEARS対応（約5行追加）
- `AI/train/Keras/Keras_train.py`: 環境変数対応（約5行追加）
- `AI/train/LightGBM/LightGBM_train.py`: 環境変数対応（約5行追加）
- `AI/train/Pycaret/Pycaret_train.py`: 環境変数対応（約5行追加）
- `AI/train/RandomForest/RandomForest_train.py`: 環境変数対応（約5行追加）

## 5. 依存関係の変更

**v2.0での変更**: なし

本プロジェクトを実行するには、v1.0と同一の`AI/requirements.txt`に記載された28パッケージが必要である。v2.0では、Python標準ライブラリのみでHTTPサーバーを実装したため、追加ライブラリのインストールは不要である。

主要なライブラリ（v1.0と同一）:
- **機械学習フレームワーク**: `tensorflow`, `keras`, `scikit-learn`, `lightgbm`, `pycaret`
- **時系列分析ライブラリ**: `statsmodels`, `pmdarima`, `sktime`, `tbats`
- **データ操作・数値計算**: `pandas`, `numpy`

## 6. 既知の問題と回避策

### 6.1. v1.0からの継承問題

#### 6.1.1. TensorFlowインストール問題
- `tensorflow`のインストールは、環境（特にCPUのAVX対応やGPUの有無）に強く依存する
- **回避策**: v1.0と同様、公式のインストール手順に従うこと

### 6.2. v2.0固有の問題

#### 6.2.1. ブラウザ互換性問題
**問題**: 古いブラウザ（IE11等）ではWebダッシュボードが正常表示されない
**回避策**: Chrome/Firefox/Edge最新版を使用すること（HTML5/CSS3標準準拠）

#### 6.2.2. ポート競合問題
**問題**: ポート8002が既に使用中の場合、HTTPサーバーが起動できない
**回避策**: 環境変数`AI_SERVER_PORT`で代替ポート番号を指定
```powershell
# 例: ポート8003を使用
$env:AI_SERVER_PORT = "8003"
py -3.10 server.py
```

#### 6.2.3. 同時実行問題
**問題**: 複数ユーザーが同時に学習実行すると、ファイルロック競合が発生する可能性
**回避策**: `ThreadingTCPServer`により並行接続対応済み（最大10接続）。ファイルロック実装により排他制御。

#### 6.2.4. タイムアウト問題
**問題**: 学習時間が40分を超えるとsubprocessタイムアウトエラーが発生
**回避策**: タイムアウト時間を調整する場合は`server.py`の`timeout=2400`を変更
```python
# 例: 60分タイムアウト
result = subprocess.run(
    ['python', 'train.py'],
    timeout=3600  # 60分
)
```

## 7. アップグレードガイド

### 7.1. v1.0 → v2.0移行手順

#### 7.1.1. 非破壊的アップグレード
v2.0は、v1.0の完全な上位互換版である。以下の手順でアップグレード可能。

**手順**:
1. v1.0のAIフォルダをバックアップ
```powershell
Copy-Item -Path "AI" -Destination "AI_v1_backup" -Recurse
```

2. v2.0の新規ファイルを追加
```powershell
# server.pyを追加
# dashboard/index.htmlを追加
```

3. v2.0の拡張ファイルを上書き
```powershell
# data/data.py（環境変数対応追加）
# train/*/train.py（環境変数対応追加）
```

4. HTTPサーバー起動
```powershell
cd AI
py -3.10 server.py
```

5. ブラウザで動作確認
```
http://localhost:8002/
```

#### 7.1.2. ロールバック手順
v2.0からv1.0に戻す場合:
```powershell
# v2.0の新規ファイル削除
Remove-Item -Path "AI\server.py"
Remove-Item -Path "AI\server.log"
Remove-Item -Path "AI\dashboard" -Recurse

# v1.0のバックアップを復元
Copy-Item -Path "AI_v1_backup\data\data.py" -Destination "AI\data\data.py"
Copy-Item -Path "AI_v1_backup\train\*\*_train.py" -Destination "AI\train\"
```

### 7.2. 段階的移行戦略

#### 7.2.1. v1.0とv2.0の並行利用
v2.0では、v1.0のCLI操作も100%サポートしているため、段階的な移行が可能。

**シナリオ1: 技術者はCLI、非技術者はWebUI**
```powershell
# 技術者: 従来通りCLI利用
cd AI\train\LightGBM
py -3.10 LightGBM_train.py 2022,2023,2024

# 非技術者: WebUI利用
# ブラウザで http://localhost:8002/ を開く
```

**シナリオ2: 開発環境はCLI、本番環境はWebUI**
```powershell
# 開発環境: デバッグ・検証はCLI
py -3.10 train.py --debug

# 本番環境: 定常運用はWebUI
py -3.10 server.py
```

## 8. パフォーマンス比較

### 8.1. 操作時間比較

#### 8.1.1. 学習実行（LightGBM、2022-2024年）
| 操作 | v1.0（CLI） | v2.0（WebUI） | 削減率 |
|------|-------------|----------------|--------|
| モデル選択 | コマンド入力30秒 | ボタンクリック1秒 | 97% |
| 年選択 | コマンド入力含む | ボタンクリック3秒 | - |
| データ処理実行 | コマンド入力20秒 | ボタンクリック1秒 | 95% |
| 学習実行 | コマンド入力20秒 | ボタンクリック1秒 | 95% |
| 結果確認 | ファイル確認60秒 | 自動表示5秒 | 92% |
| **合計** | **約110秒** | **約9秒** | **92%** |

#### 8.1.2. モデル切替（LightGBM → RandomForest）
| 操作 | v1.0（CLI） | v2.0（WebUI） | 削減率 |
|------|-------------|----------------|--------|
| ディレクトリ移動 | 10秒 | 不要 | - |
| コマンド再入力 | 20秒 | ボタンクリック2秒 | 90% |
| **合計** | **約30秒** | **約2秒** | **93%** |

### 8.2. リソース使用量比較

#### 8.2.1. メモリ使用量
| コンポーネント | v1.0 | v2.0 | 差異 |
|--------------|------|------|------|
| データ処理基盤 | 約600MB | 約600MB | 0% |
| モデル学習（LightGBM） | 約1.5GB | 約1.5GB | 0% |
| HTTPサーバー | - | 約20MB | +20MB |
| ブラウザ（Chrome） | - | 約30MB | +30MB |
| **合計** | **約2.1GB** | **約2.15GB** | **+2.4%** |

#### 8.2.2. CPU使用率
| 処理 | v1.0 | v2.0 | 差異 |
|------|------|------|------|
| データ処理 | 80-90% | 80-90% | 0% |
| モデル学習 | 90-100% | 90-100% | 0% |
| HTTPサーバー（アイドル） | - | 1-2% | +1-2% |
| HTTPサーバー（実行中） | - | 5-10% | +5-10% |

#### 8.2.3. ディスク使用量
| 項目 | v1.0 | v2.0 | 差異 |
|------|------|------|------|
| Pythonスクリプト | 約500KB | 約500KB | 0% |
| server.py | - | 約10KB | +10KB |
| dashboard/index.html | - | 約50KB | +50KB |
| server.log | - | 約2MB（運用後） | +2MB |
| **合計** | **約150MB** | **約152MB** | **+1.3%** |

---
