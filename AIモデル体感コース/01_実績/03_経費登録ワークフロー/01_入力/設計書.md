# UiPathワークフローPython変換 - 設計書

※ この資料は教育用のサンプルです。

## 1. システム概要

### 1.1. 目的・背景
UiPath Main.xamlをPythonに変換し、単一ファイルで経費登録の自動化を実現する。

本システムは、UiPathで作成された経費登録ワークフローをPythonスクリプトに変換し、自動化を実現することを目的とする。

### 1.2. 適用範囲
本設計書は、UiPathで作成されたMain.xamlのワークフローをPythonで再実装するための技術仕様を定義する。Webブラウザを使用した経費登録の自動化を目的とし、Excelファイルの読み書き、Web操作、エラーハンドリング、ログ出力などの機能詳細を定義する。

- スコープ: Main.xamlの主要なロジック（Excel読み込み、Web操作、結果書き込み）を対象とする
- 前提・制約: Python実行環境および、requirements.txtに記載されたライブラリがインストールされていることを前提とする

### 1.3. 前提・制約
- 元システム: UiPath Main.xaml
- 対象環境: Python 3.10.11
- 実行環境: VS Code
- 主要ライブラリ: selenium、pandas、openpyxl、webdriver-manager、requests、os、time、logging、tkinter

## 2. 全体アーキテクチャ

### 2.1. 構成図

```
+----------------------+
| Python実行環境       |
| +------------------+ |
| | 経費登録.py      | |
| +------------------+ |
|         |            |
| (reads/writes)     |
|         v            |
| +------------------+ |
| | data.xlsx        | |
| +------------------+ |
+----------------------+
```

```
Python システム
├── 経費登録.py（単一実行ファイル）
├── data.xlsx（処理対象データ）
├── expense_automation.log（ログファイル）
└── requirements.txt（依存関係）
```

### 2.2. デプロイメント
単一ファイル経費登録.pyとして実装

### 2.3. 利用技術

requirements.txtに基づき、以下の主要ライブラリを利用する。

- requests: ファイルダウンロード
- pandas: Excelデータ操作
- openpyxl: Excelファイル書き込み
- selenium: Webブラウザ自動操作
- webdriver-manager: WebDriverの自動管理

| ライブラリ名 | 用途 | インポート例 |
|--------------|------|-------------|
| selenium | Webブラウザ自動化 | from selenium import webdriver |
| webdriver-manager | WebDriver自動管理 | from webdriver_manager.microsoft import EdgeChromiumDriverManager |
| pandas | Excel読み取り | import pandas as pd |
| openpyxl | Excel書き込み | from openpyxl import load_workbook |
| requests | ファイルダウンロード | import requests |
| os | ファイル操作 | import os |
| time | 待機処理 | import time |
| logging | ログ出力 | import logging |
| tkinter | メッセージ表示 | import tkinter.messagebox as messagebox |

### 2.4. 依存関係管理
requirements.txtで定義される依存関係：
```
requests>=2.28.0
pandas>=1.5.0
openpyxl>=3.0.10
selenium>=4.10.0
webdriver-manager>=4.0.0
urllib3>=1.26.0
```

## 3. コンポーネント設計

### 3.1. 責務分担
推奨関数構成：
- check_and_download_file(): ファイル存在確認とダウンロード
- initialize_webdriver(): WebDriver初期化（ローカルフォールバック付き）
- read_excel_data(): Excel読み取り
- click_expense_register(): 「経費を登録する」メニュークリック
- process_single_row(row_data): 1行分の明細登録処理
- input_form_data(title, category, amount, remarks): フォームデータ入力
- get_registration_code(): 登録コード取得
- update_excel_with_code(row_index, code): Excelにコード書き戻し
- show_completion_message(total_rows, success_count): 完了メッセージ表示
- main(): メイン処理

### 3.2. 依存関係
| UiPathセレクタ | Seleniumメソッド | 例 |
|----------------|------------------|-----|
| id='xxx' | find_element(By.ID, 'xxx') | driver.find_element(By.ID, 'ledger_ledger_name') |
| tag='A' | find_element(By.TAG_NAME, 'a') | driver.find_element(By.TAG_NAME, 'a') |
| aaname='xxx' | find_element(By.LINK_TEXT, 'xxx') | driver.find_element(By.LINK_TEXT, '経費を登録する') |
| tag='SELECT' | Select(find_element(...)) | Select(driver.find_element(By.TAG_NAME, 'select')) |

### 3.3. シーケンス図

Main.xamlのロジックに基づき、以下の順序で処理が実行される。

1. ファイル準備: data.xlsxが存在しない場合、指定URLからダウンロードする
2. ブラウザ起動: Seleniumを用いてEdgeブラウザを起動し、経費登録サイトにアクセスする
3. データ処理ループ: Excelの各行に対して以下の処理を繰り返す
   1. 経費登録ページに遷移する
   2. フォーム（タイトル、種別、金額、備考）にデータを入力する
   3. 「登録」ボタンをクリックする
   4. 登録完了ページから登録コードを取得する
   5. 取得したコードをExcelの「番号」列に書き込む
   6. 一覧ページに戻る

#### 3.3.1. メインフロー
1. 準備段階
   - 1.1. data.xlsxファイル存在確認
   - 1.2. ファイルが存在しない場合、URLからダウンロード
   - 1.3. WebDriverの初期化

2. Excel処理段階
   - 2.1. Excelファイル（data.xlsx）を開く
   - 2.2. Sheet1のデータを読み取り
   - 2.3. 各行を順次処理

3. ブラウザ操作段階
   - 3.1. 経費登録サイトにアクセス
   - 3.2. 「経費を登録する」メニューをクリック
   - 3.3. 各行データについて経費明細登録を実行

4. 明細登録段階（行ごと繰り返し）
   - 4.1. 「明細を登録する」ボタンをクリック
   - 4.2. フォーム入力（タイトル、種別、金額、備考）
   - 4.3. 「登録する」ボタンをクリック
   - 4.4. 登録コードを取得
   - 4.5. 取得したコードをExcelの「番号」列に書き込み
   - 4.6. 「戻る」ボタンをクリック

5. 完了段階
   - 5.1. 全行処理完了後の通知表示
   - 5.2. ブラウザ終了

#### 3.3.2. 詳細処理ロジック

##### ファイル確認・ダウンロード
```text
IF data.xlsx が存在する:
    メッセージ表示「ファイルが存在します。」
ELSE:
    URLからファイルをダウンロード「https://www.expense-demo.com/data.xlsx」
    メッセージ表示「ファイルを URL からダウンロードしました。」
```

##### Excel読み取り
- ファイル名: data.xlsx
- シート名: Sheet1
- ヘッダー設定: HasHeaders=True
- 必要カラム: タイトル、種別、金額、備考、番号

##### ブラウザ操作詳細
- 対象URL: https://www.expense-demo.com/
- ブラウザ: Microsoft Edge
- 操作モード: Simulate（UiPath）→ Selenium WebDriver（Python）

## 4. データベース設計

本システムではデータベースは使用せず、data.xlsxファイルを入出力データとして扱う。

### 4.1. データ構造（Excelファイル）

#### カラム構造
| カラム名 | データ型 | 用途 | 例 |
|----------|----------|------|-----|
| タイトル | 文字列 | 経費のタイトル | "交通費" |
| 種別 | 文字列 | 経費の種別 | "立替" |
| 金額 | 数値または文字列 | 金額 | "1000" |
| 備考 | 文字列 | 備考欄 | "往復交通費" |
| 番号 | 文字列 | 登録コード格納欄 | "455414" |

#### 読み取り仕様
- ファイル名: data.xlsx
- シート名: Sheet1
- ヘッダー行: 1行目をヘッダーとして扱う
- 読み取り方法: pandas.read_excel()

#### 書き込み仕様
- 対象列: 番号（Column名: "番号"）
- 書き込み値: 登録後に取得したコード（6桁数字）
- 書き込み方法: openpyxl経由で既存ファイルを更新

### 4.2. バックアップ/リストア
- 処理前の自動バックアップ機能実装
- 書き込み権限エラーの処理

## 5. インターフェース設計

### 5.1. API仕様

#### 5.1.1. エンドポイント
- 対象URL: https://www.expense-demo.com/
- ページ基本情報: `<html app='msedge.exe' title='UiPath Demo' />`

#### 5.1.2. リクエスト/レスポンス仕様

##### UI要素セレクタ情報

###### メニュー操作
| 要素名 | セレクタ | 代替セレクタ |
|--------|----------|-------------|
| 経費を登録する | `<webctrl aaname='経費を登録する' tag='A' />` | `<webctrl aaname='経費を登録する' tag='A' type='' class='btn btn-primary btn-block menu-link' />` |

###### フォーム入力要素
| 項目 | ID | セレクタ | 入力タイプ |
|------|----|---------|---------  |
| タイトル* | ledger_ledger_name | `<webctrl id='ledger_ledger_name' tag='INPUT' type='text' />` | テキスト入力 |
| 種別* | - | `<webctrl tag='SELECT' aaname='種別*' />` | セレクトボックス |
| 金額* | ledger_cost | `<webctrl id='ledger_cost' tag='INPUT' type='text' />` | テキスト入力 |
| 備考 | ledger_remarks | `<webctrl id='ledger_remarks' tag='INPUT' type='text' />` | テキスト入力 |

###### 操作ボタン
| 要素名 | セレクタ | 説明 |
|--------|----------|------|
| 明細を登録する | `<webctrl id='newTx' tag='A' />` | 新規明細登録画面遷移 |
| 登録する | `<webctrl tag='INPUT' type='submit' />` | フォーム送信 |
| 戻る | `<webctrl aaname='戻る' tag='A' />` | 前画面に戻る |

###### コード取得要素
| 要素名 | セレクタ | 説明 |
|--------|----------|------|
| コード値 | `<webctrl idx='1' tag='DD' />` | 登録後に表示されるコード |
| コードラベル | `<webctrl idx='1' tag='STRONG' aaname='コード:' />` | 「コード:」ラベル |

###### 種別選択肢
- 空白（デフォルト）
- 立替
- 仮払
- その他

### 5.2. 外部連携

- ファイル連携: data.xlsxを読み込み、処理結果を同ファイルに書き戻す

#### ファイル連携
- data.xlsxファイルの存在確認と自動ダウンロード
- URLからのファイルダウンロード: https://www.expense-demo.com/data.xlsx
- Excelファイル（data.xlsx）の読み書き処理

## 6. アプリケーション設計

### 6.1. 業務フロー/シーケンス

Main.xamlのロジックに基づき、以下の順序で処理が実行される。

1. ファイル準備: data.xlsxが存在しない場合、指定URLからダウンロードする
2. ブラウザ起動: Seleniumを用いてEdgeブラウザを起動し、経費登録サイトにアクセスする
3. データ処理ループ: Excelの各行に対して以下の処理を繰り返す
   1. 経費登録ページに遷移する
   2. フォーム（タイトル、種別、金額、備考）にデータを入力する
   3. 「登録」ボタンをクリックする
   4. 登録完了ページから登録コードを取得する
   5. 取得したコードをExcelの「番号」列に書き込む
   6. 一覧ページに戻る

#### 主要機能
- data.xlsxファイルの存在確認と自動ダウンロード
- Excelファイルの読み取り（Sheet1、ヘッダー有り）
- Webブラウザでの経費登録Webアプリ操作
- 登録後のコード取得とExcelへの書き戻し

### 6.2. バッチ/ジョブ

#### 実行手順
- 仮想環境をアクティベート: .\.venv\Scripts\activate
- スクリプト実行: python .\経費登録.py

#### 前提条件
1. Python 3.10.11がインストール済み
2. 仮想環境(.venv)が作成済み
3. requirements.txtから依存関係インストール済み

### 6.3. 例外処理・リトライ

GlobalHandlerX.xamlのロジックを参考に、Pythonのtry-exceptブロックで例外処理を実装する。主な機能は以下の通りである。

- エラーログ: 発生した例外の詳細をログファイルに出力する
- ユーザーへの通知と選択: エラー発生時に、ユーザーに処理の継続方法（再試行、スキップ、停止など）を選択させるダイアログを表示する
- 多言語対応: エラーメッセージは実行環境の言語設定（日本語、英語など）に応じて表示される

#### 必須エラーハンドリング
1. WebDriver起動失敗
   - webdriver-manager失敗時のローカルドライバ使用
   - ドライバパス指定での起動

2. 要素検出失敗
   - 複数セレクタでの要素検索
   - 明示的待機（WebDriverWait）の実装
   - 要素が見つからない場合のスキップ処理

3. ネットワーク関連
   - ダウンロード失敗時の処理継続
   - ページ読み込みタイムアウト処理

4. Excel処理失敗
   - ファイル読み込み失敗時の終了処理
   - 書き込み権限エラーの処理

#### リトライ機能
- 対象操作: クリック、テキスト入力、要素検索
- リトライ回数: 3回
- 待機時間: 2秒間隔

### 6.4. ログ・監視・メトリクス

#### ログ出力要件
- ログファイル: expense_automation.log
- ログレベル: INFO, ERROR
- 出力内容: 処理開始・終了、エラー詳細、各行の処理結果

### 6.5. 設定管理・Secrets

#### 設定の外部化
- 設定値は上部で定数として定義
- DOWNLOAD_URL = "https://www.expense-demo.com/data.xlsx"
- EXCEL_FILE_PATH = "./data.xlsx"
- SHEET_NAME = "Sheet1"
- WAIT_TIMEOUT = 10
- LOG_FILE_PATH = "./expense_automation.log"

### 6.6. セキュリティ設計

#### セキュリティ要件
開発ガイドライン・コーディング規約に準拠し、以下のセキュリティ要件を遵守する：
- パスワード等のセキュア情報をコード・設定ファイル・ログファイルに記録禁止
- システムに対する過度な負荷を与える自動化の禁止
- 重要なデータに対する更新前の人間による確認手順の実装

## 7. 非機能要件への対応

### 7.1. 拡張性

#### 拡張性設計
- 複数AIモデル対応のための基盤設計
- モジュラー関数設計による機能追加容易性
- 統一エラーハンドリングによる安定性確保

### 7.2. 保守性

#### 保守性設計
- 単一ファイル構成による簡潔な構造
- 関数分割による可読性向上
- 詳細ログ記録による問題解析支援
- 設定外部化による環境別対応

### 7.3. 運用性

#### 完了時の動作仕様

##### 完了通知
- GUI環境: tkinter.messageboxで処理結果表示
- CUI環境: コンソールに結果出力
- 表示内容: 処理行数、成功件数、失敗件数、所要時間

##### ブラウザ終了
- タイミング: ユーザが完了通知でOKボタンを押下後
- 終了方法: driver.quit()

## 8. テスト方針

### 8.1. テストケース

#### 正常系テスト
1. 小規模データテスト
   - 3行のテストデータで全工程実行
   - 各行に登録コードが正しく設定されることを確認

2. ファイルダウンロードテスト
   - data.xlsxを削除した状態で実行
   - 自動ダウンロード後に処理が継続されることを確認

#### 異常系テスト
1. ネットワーク切断テスト
   - オフライン環境での実行
   - ローカルドライバでの動作確認

2. 要素検出失敗テスト
   - 存在しない種別を指定
   - エラーログ出力と処理継続を確認

### 8.2. 動作確認結果

#### 実行環境
- Python: 3.10.11
- 仮想環境: .venv （プロジェクトルート）
- 依存関係: requirements.txtから正常インストール
- WebDriver: Selenium 4内蔵ドライバマネージャ使用

#### 実行結果
- 処理対象行数: 3
- 成功件数: 3/3
- 失敗件数: 0
- 処理時間: 約68秒
- 実行ログ抜粋:
  - data.xlsxファイル存在確認・ダウンロード: 成功
  - WebDriver初期化: 成功（Selenium内蔵マネージャ）
  - 経費登録サイトアクセス: 成功
  - 各行の明細登録処理: 全行成功
    - 行1: タイトル「交際費」→ コード563696取得
    - 行2: タイトル「宿泊費」→ コード563697取得
    - 行3: タイトル「交際費」→ コード563698取得
  - Excel書き戻し: 全行成功
  - 完了通知・ブラウザ終了: 正常

#### Excel更新結果
- タイトル: 交際費, 種別: その他, 金額: 5030, 備考: 先月分, 番号: 563696
- タイトル: 宿泊費, 種別: 立替, 金額: 7590, 備考: ホテル代, 番号: 563697
- タイトル: 交際費, 種別: 仮払, 金額: 10980, 備考: 今月分, 番号: 563698

#### 技術的改善点
1. WebDriver初期化: Selenium 4の内蔵ドライバマネージャを第一選択肢として採用
2. 要素検出: 複数セレクタによる堅牢な要素検索を実装
3. エラーハンドリング: リトライ機能付きの安全な操作を実装
4. コード取得: 正規表現による確実なコード抽出を実装

### 8.3. 品質保証

#### 品質基準
- 機能充足率: 100%（UiPath元機能の完全再現）
- 処理成功率: 98.5%以上
- エラー発生率: 1.5%以下
- セキュリティコンプライアンス: 開発ガイドライン完全準拠

#### 実装上の注意事項

##### コーディング規約準拠
- 変数命名: snake_case（例: driver_manager）
- 関数命名: 動詞_目的語形式（例: click_expense_register）
- 定数命名: UPPER_CASE（例: DOWNLOAD_URL）
- コメント: 日本語コメント推奨、英語識別子

##### 単一ファイル実装
- ファイル構成: 経費登録.py 1ファイルのみ
- モジュール分割: 禁止
- 関数分割: 可読性向上のため推奨

## 9. 付録

### 9.1. システムアーキテクチャ解析

#### xamlフォルダ構成解析
```
xaml/
├── Main.xaml（メインワークフロー）
├── GlobalHandlerX.xaml（例外処理）
├── Project_Notebook.ja.xlsx（設定ファイル）
└── project.json（プロジェクト設定）
```

#### アーキテクチャ変換対応表
| UiPath要素 | Python実装 | 変換理由 |
|------------|------------|----------|
| Main.xaml | main()関数 | メイン処理の統合 |
| GlobalHandlerX.xaml | try-except文 | 統一エラーハンドリング |
| Excel Activities | pandas + openpyxl | 高速データ処理 |
| Browser Activities | Selenium WebDriver | 堅牢なブラウザ制御 |
| Message Box | tkinter.messagebox | クロスプラットフォーム対応 |
| Variables | 関数引数・戻り値 | スコープ管理の改善 |

### 9.2. 依存関係リスト

```txt
requests>=2.28.0
pandas>=1.5.0
openpyxl>=3.0.10
selenium>=4.10.0
webdriver-manager>=4.0.0
urllib3>=1.26.0
```
