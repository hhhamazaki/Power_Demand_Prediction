# 経費登録ワークフロー自動化システム開発 - 要件定義書

※ この資料は教育用のサンプルです。

## 1. ビジネス要件

### 1.1. 目的・背景
経理部門における月次経費登録業務（500件/月）の完全自動化により、手動作業時間を80%削減（40時間/月 → 8時間/月）し、入力ミス率を95%削減（10-15件/月 → 0-1件/月）することで、年間480万円のコスト削減効果を実現する。

### 1.2. 適用範囲
- 経費申請データのExcelファイル読込・処理
- WebベースexpenseSystemへの自動登録
- 登録結果の検証・レポート生成
- エラーハンドリング・例外処理

### 1.3. KPI/成功指標
| 改善項目 | 現状 | 目標 | 改善効果 |
|---------|------|------|----------|
| 月間処理時間 | 40.0時間 | 4.0時間 | 90%削減 |
| エラー発生率 | 2-3% | 0.1%以下 | 95%削減 |
| 月間処理件数 | 500件 | 1000件 | 200%向上 |
| 人的工数 | 100% | 10% | 90%削減 |
| 監査対応時間 | 8時間 | 1時間 | 87.5%削減 |

## 2. 利用者・ステークホルダー

- 利用者: 経理部門担当者

## 3. ユースケース/業務フロー

1. 利用者は、経費データが入力されたdata.xlsxを準備する
2. 利用者は、任意のAIモデルのPythonスクリプトを実行する
3. システムは、data.xlsxを読み込み、Webブラウザを自動で起動・操作する
4. システムは、データに基づいて経費登録フォームへの入力と登録を一件ずつ実行する
5. システムは、登録後に得られる登録コードをdata.xlsxの「番号」列に書き込む
6. 全件処理後、システムは処理結果をGUIメッセージで利用者に通知する

## 4. 機能要件

### 4.1. データ入力機能

#### ファイル形式要件
```python
@dataclass
class DataInputRequirement:
    """データ入力機能要件"""
    supported_formats: List[str] = field(default_factory=lambda: [".xlsx", ".xls"])
    required_columns: List[str] = field(default_factory=lambda: ["タイトル", "種別", "金額", "備考"])
    encoding_support: str = "UTF-8, Shift-JIS"
    max_file_size: str = "10MB"
```

#### データ検証要件
| 項目 | 検証ルール | エラー処理 |
|------|-----------|-----------|
| タイトル | 必須、最大100文字 | 欠損時エラー・長すぎる場合切り詰め |
| 種別 | 必須、プルダウンリストから選択 | 無効値の場合デフォルト値設定 |
| 金額 | 必須、数値、0以上 | 非数値の場合エラー・負値の場合絶対値 |
| 備考 | 任意、最大500文字 | 長すぎる場合切り詰め |

### 4.2. Web自動操作機能

#### ブラウザ操作要件
```python
@dataclass
class WebAutomationRequirement:
    """Web自動操作機能要件"""
    supported_browsers: List[str] = field(default_factory=lambda: ["Edge", "Chrome", "Firefox"])
    browser_options: Dict[str, Any] = field(default_factory=lambda: {
        "headless": False,           # GUI表示（Attended Robot）
        "maximize_window": True,     # ウィンドウ最大化
        "disable_notifications": True, # 通知無効化
        "disable_extensions": True   # 拡張機能無効化
    })
```

#### 操作機能要件
| 機能 | 要件 | 実装方式 |
|------|------|----------|
| 要素クリック | 要素の可視化・クリック可能状態を待機 | WebDriverWait + expected_conditions |
| テキスト入力 | 入力前の既存値クリア・文字列設定 | clear() + send_keys() |
| プルダウン選択 | 選択肢の存在確認・値設定 | Select() クラス使用 |
| ページ遷移 | ページ読み込み完了を待機 | document.readyState確認 |
| 要素待機 | タイムアウト設定・例外処理 | 10秒基本・30秒長時間 |
| スクリーンショット取得 | エラー時の画面キャプチャ | PNG形式で保存 |

### 4.3. AI統合機能

#### マルチAIモデル実装要件
```python
class AIModelSelector:
    """AIモデル選択機能"""
    def select_optimal_model(self, data_complexity: str, performance_priority: str) -> str:
        if data_complexity == "high" and performance_priority == "accuracy":
            return "claude_sonnet_4"      # 高精度・複雑処理
        elif performance_priority == "speed":
            return "claude_sonnet_3.5"    # 高速処理
        elif performance_priority == "balance":
            return "gpt-4.1"              # バランス型
        else:
            return "gpt-5"                # 次世代型
```

#### AIモデル性能要件
| AIモデル | 処理時間目標 | 精度要件 | 用途 |
|----------|-------------|---------|------|
| Claude Sonnet 3.5 | 7秒/3件 | 98%以上 | 高速バッチ処理 |
| Claude Sonnet 4.0 | 10秒/3件 | 99.5%以上 | 高精度処理 |
| GPT-4.1 | 9秒/3件 | 99%以上 | 標準処理 |
| GPT-5 | 9秒/3件 | 99.5%以上 | 高度機能 |

- FR-1: データ入力機能
  - FR-1.1: data.xlsxが存在しない場合、指定URLから自動ダウンロードすること
  - FR-1.2: pandasライブラリを用いてExcelファイルを読み込めること
  - FR-1.3: 必須列（タイトル、種別、金額など）の存在をチェックできること
- FR-2: Web自動操作機能
  - FR-2.1: seleniumライブラリを用いてEdgeブラウザを起動し、指定URLにアクセスできること
  - FR-2.2: Excelの各行のデータをWebフォームに正しく入力できること
  - FR-2.3: 登録ボタンをクリックし、フォームを送信できること
  - FR-2.4: 登録完了後に表示される登録コードを正しく取得できること
- FR-3: データ出力機能
  - FR-3.1: 取得した登録コードを、openpyxlを用いて元のExcelファイルの正しい行に書き込めること
  - FR-3.2: 処理の進捗やエラー情報をexpense_automation.logファイルに出力すること
- FR-4: 通知機能
  - FR-4.1: 処理完了後、tkinterを用いてGUIメッセージボックスで結果を通知すること

## 5. 非機能要件

### 5.1. 性能要件

#### 処理性能目標
- 1件あたり処理時間: 平均3秒以内
- 500件バッチ処理: 25分以内（初期化時間含む）
- CPU使用率: 70%以下で安定稼働
- メモリ使用量: 2GB以下で効率運用

#### 応答性能要件
- WebDriver初期化: 10秒以内
- ページ読み込み: 30秒以内
- 要素検索: 10秒以内
- ファイルI/O: 5秒以内

#### 依存関係要件
requirements.txtで管理される技術基盤：
```
requests>=2.28.0
pandas>=1.5.0
openpyxl>=3.0.10
selenium>=4.10.0
webdriver-manager>=4.0.0
urllib3>=1.26.0
```

### 5.2. セキュリティ要件

#### データ保護要件
```python
@dataclass
class SecurityRequirement:
    """セキュリティ要件"""
    encryption_method: str = "AES-256"          # データ暗号化
    https_enforcement: bool = True              # HTTPS通信強制
    credential_management: str = "environment"   # 認証情報管理
    log_masking: bool = True                    # ログマスキング
    audit_logging: bool = True                  # 監査ログ
```

#### アクセス制御
- 実行権限: 認証済みユーザーのみ実行可能
- データアクセス: 最小権限の原則適用
- ログアクセス: 管理者・監査者のみ閲覧可能

### 5.3. 可用性要件

#### 稼働率要件
- システム稼働率: 99.9%以上（月間ダウンタイム 44分以内）
- データ整合性: 100%（データ欠損・破損ゼロ）
- エラー回復時間: 平均5分以内

#### 障害対応要件
```python
@robust_automation(max_retries=3, delay=2.0)
def disaster_recovery_system():
    """障害回復システム"""
    # 自動リトライ機能
    # フェイルオーバー機能
    # 処理状態保存・復旧機能
    # 自動通知機能
```

- NFR-1 (堅牢性): Webページの要素特定には、ID、XPath、CSSセレクタなど複数の方法を試し、UIの軽微な変更に耐えられるようにする
- NFR-2 (エラーハンドリング): try-exceptブロックによる例外捕捉を実装する。特にTimeoutExceptionやStaleElementReferenceExceptionなど、Web自動化特有のエラーを適切に処理し、必要に応じてリトライ処理を行う
- NFR-3 (保守性): URLやタイムアウト値などの設定値は、スクリプト上部で定数または設定クラスとして一元管理する

## 6. データ要件

### 6.1. 入力データ構造

#### Excelファイル仕様
- ファイル名: data.xlsx
- シート名: Sheet1
- ヘッダー行: 1行目
- エンコーディング: UTF-8

#### 必要カラム定義
| カラム名 | データ型 | 必須 | 制約条件 | 例 |
|----------|----------|------|----------|-----|
| タイトル | 文字列 | ✓ | 1-100文字 | "交通費" |
| 種別 | 文字列 | ✓ | 立替・仮払・その他 | "立替" |
| 金額 | 数値・文字列 | ✓ | 0以上の数値 | "1000" |
| 備考 | 文字列 | - | 0-500文字 | "往復交通費" |
| 番号 | 文字列 | - | 登録コード格納 | "455414" |

### 6.2. 出力データ要件

#### 処理結果データ
- 登録コード: 6桁数字（例：455414）
- 処理ステータス: 成功・失敗・スキップ
- エラー内容: 失敗時の詳細情報
- 処理時刻: 登録完了時刻

#### レポートデータ
- 処理サマリ: 総件数・成功件数・失敗件数
- 性能データ: 処理時間・平均時間・最大時間
- エラー統計: エラー種別・発生頻度

- 入力データ: data.xlsx
  - シート名: Sheet1
  - 必須カラム: タイトル, 種別, 金額, 備考
- 出力データ: data.xlsx
  - 追記カラム: 番号 (処理後に取得した登録コードを格納)

## 7. 外部インターフェース要件

### 7.1. WebシステムAPI仕様

#### 接続仕様
- 対象URL: https://www.expense-demo.com/
- 認証方式: セッションベース認証
- 通信プロトコル: HTTPS
- エンコーディング: UTF-8

#### UI要素仕様
| 要素名 | 識別方式 | セレクタ値 | 操作内容 |
|--------|----------|-----------|----------|
| 経費を登録する | LINK_TEXT | "経費を登録する" | メニュークリック |
| 明細を登録する | ID | "newTx" | 新規登録ボタン |
| タイトル | ID | "ledger_ledger_name" | テキスト入力 |
| 種別 | TAG_NAME | "select" | プルダウン選択 |
| 金額 | ID | "ledger_cost" | 数値入力 |
| 備考 | ID | "ledger_remarks" | テキスト入力 |
| 登録する | XPATH | "//input[@type='submit']" | 送信ボタン |
| 登録コード | XPATH | "//dd[1]" | 結果取得 |

### 7.2. ファイルシステム仕様

#### ディレクトリ構造
```text
C:\Users\<UserName>\<project_root>\03_経費登録ワークフロー\
├── py\                          # 実行スクリプト
│   ├── 経費登録_claude_sonnet_4.py
│   ├── 経費登録_gpt-4.1.py
│   ├── 経費登録_claude_sonnet_3.5.py
│   └── 経費登録_gpt-5.py
├── data.xlsx                    # 入力データ
├── requirements.txt             # 依存関係
└── expense_automation.log       # 実行ログ
```

- Webシステム: https://www.expense-demo.com/ との画面操作による連携

## 8. 運用・保守要件

### 8.1. 運用要件

#### 監視要件
- システム監視: CPU・メモリ・ディスク使用率
- アプリケーション監視: 処理件数・エラー率・応答時間
- ネットワーク監視: 通信状況・パケットロス

#### ログ要件
```python
@dataclass
class LoggingRequirement:
    """ログ要件"""
    log_file: str = "expense_automation.log"
    rotation: str = "daily"                     # 日次ローテーション
    retention_days: int = 7                     # 7日間保持
    log_levels: List[str] = field(default_factory=lambda: ["INFO", "ERROR", "DEBUG"])
    
    log_items: List[str] = field(default_factory=lambda: [
        "処理開始・終了時刻",
        "処理件数・成功件数・失敗件数",
        "エラー内容・発生時刻",
        "実行ユーザー・処理ファイル名"
    ])
```

### 8.2. 実行環境要件
- OS: Windows 10/11（64bit）
- Python: 3.10.11以上
- メモリ: 最小4GB、推奨8GB
- ストレージ: 最小1GB空き容量

### 8.3. 運用手順要件
- 事前準備: 仮想環境作成・依存関係インストール
- 実行方法: コマンドライン実行または定期実行
- 結果確認: ログファイル・Excel更新確認
- エラー対応: ログ解析・スクリーンショット確認

### 8.4. 保守要件
- 定期メンテナンス: 月1回のログクリーンアップ
- 性能監視: 週1回の性能指標確認
- セキュリティ: 月1回の依存関係更新

- ログ: expense_automation.log に実行ログが記録されるため、問題発生時はこのファイルを確認する

## 9. 制約条件・前提条件・依存関係

### 9.1. 技術制約
- WebDriverManagerのネットワーク依存性
- Seleniumの要素検出タイミング依存性
- Excelファイルの同時アクセス制限

### 9.2. 業務制約
- 営業時間内の実行制限（システム負荷軽減）
- 月末処理時の優先度調整
- 他部門システムとの競合回避

### 9.3. セキュリティ制約
- 認証情報の平文保存禁止
- ログファイルへの機密情報記録禁止
- 外部通信の監査ログ記録必須

- 制約: Microsoft Edgeブラウザが利用可能なWindows環境での実行を想定
- 依存関係: requirements.txtに記載されたライブラリが必要

```txt
requests>=2.28.0
pandas>=1.5.0
openpyxl>=3.0.10
selenium>=4.10.0
webdriver-manager>=4.0.0
urllib3>=1.26.0
```

## 10. 用語集

### 10.1. 技術用語
- WebDriver: Webブラウザ自動操作ライブラリ
- robust_automation: 統一エラーハンドリングデコレータ
- @dataclass: Python設定クラス定義方式
- requirements.txt: Python依存関係管理ファイル

### 10.2. 業務用語
- 経費登録: 経費データのシステム入力処理
- 明細: 個別の経費項目データ
- 登録コード: システム発行の処理識別番号
- 種別: 経費の分類（立替・仮払・その他）

### 10.3. 品質要件

#### 品質方針
- 4つのAIモデル（Claude Sonnet 3.5・4.0、GPT-4.1・5）による高品質・高精度処理
- 統一エラーハンドリングによる安定性確保
- 設定外部化による保守性向上
- 詳細ログ記録による問題解析支援

#### 検証基準
- 機能要件充足率: 100%
- 非機能要件達成率: 95%以上
- セキュリティ要件準拠: 100%
- 運用要件満足度: 90%以上

### 10.4. 受入基準

#### 機能受入基準
- Excelファイルの正常読み込み（3件以上のテストデータ）
- Webページへの自動アクセス・ログイン
- フォームへの自動入力（全項目）
- 登録処理の自動実行
- 登録コードの自動取得・Excel書き戻し
- 処理完了通知の表示

#### 性能受入基準
- 3件処理を10秒以内で完了
- CPU使用率70%以下で安定稼働
- メモリ使用量500MB以下
- エラー率1%以下

#### 運用受入基準
- 設定ファイルによる動作変更
- ログファイルによる実行状況確認
- エラー時の適切な通知・報告
- 定期実行（スケジュール実行）対応

### 10.5. リスク管理

#### 技術リスク
- WebDriver環境の互換性問題
- ネットワーク接続の不安定性
- Excel文字コード問題

#### 業務リスク
- 経費システムの仕様変更
- データ形式の変更
- 処理量の急激な増加

#### セキュリティリスク
- 認証情報の漏洩
- ログファイルの不正アクセス
- 処理データの改ざん

- Selenium: Webブラウザを自動操作するためのフレームワーク
- WebDriver: ブラウザを操作するためのAPI
- dataclass: Pythonで構造化されたデータを簡潔に定義するための機能
