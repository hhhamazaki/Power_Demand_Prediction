# 経費管理システムWebアプリケーション開発 - 要件定義書

※ この資料は教育用のサンプルです。

## 1. ビジネス要件

-   **目的**: 経費管理業務の効率化とデータ可視化を実現する、クライアントサイドで完結するWebアプリケーションを提供する。
-   **KPI**: 経費登録時間の50%削減、データ入力エラーの30%削減。

### 1.1. 目的・背景
経費管理業務の効率化とデータ品質向上を図るWebアプリケーションを提供する。開発ガイドラインに準拠した高品質なコードベースとパフォーマンス最適化により、企業レベルの要求に応える。

### 1.2. 適用範囲
- システム設計・開発（HTML5 + ES6モジュール実装）
- テスト計画・実行（ブラウザ互換性・パフォーマンステスト）
- 運用・保守（LocalStorage管理・セキュリティ監視）
- 品質保証（セキュリティ監査・コード品質チェック）
- パフォーマンス最適化（仮想スクロール・キャッシング）

### 1.3. 主要機能
1. **経費管理機能**: 登録・編集・削除・一覧表示（仮想スクロール対応）
2. **データ管理機能**: CSVインポート・エクスポート・LocalStorageバックアップ
3. **分析機能**: リアルタイムダッシュボード・Chart.jsレポート・統計表示
4. **セキュリティ機能**: CSP・セッション管理・入力検証・監査ログ

## 2. 利用者・ステークホルダー

-   **利用者**: 経費の申請および管理を行う従業員。

### 2.1. 基本プラットフォーム
- **実行環境**: Webブラウザ（HTTPサーバー経由アクセス必須）
- **技術スタック**: HTML5、CSS3、JavaScript（ES6+）
- **外部ライブラリ**: Chart.js 4.x（CDN経由）、ChartDataLabels 2.x
- **開発ツール**: VS Code、Live Server、GitHub Copilot

### 2.2. ブラウザ要件
| ブラウザ | 最小バージョン | 推奨バージョン | ES6モジュール対応 |
|----------|---------------|---------------|------------------|
| Google Chrome | 90+ | 最新版 | ✓ |
| Mozilla Firefox | 88+ | 最新版 | ✓ |
| Microsoft Edge | 90+ | 最新版 | ✓ |
| Safari | 14+ | 最新版 | ✓ |

### 2.3. システム要件
- **画面解像度**: 1024×768以上（レスポンシブ対応）
- **メモリ**: 最小4GB、推奨8GB RAM
- **ストレージ**: LocalStorage 10MB利用可能
- **ネットワーク**: Chart.js CDNアクセス可能（https://cdn.jsdelivr.net）

## 3. ユースケース/業務フロー

-   ユーザーはホーム画面で経費サマリーを確認し、ナビゲーションを通じて各機能（経費登録、一覧、レポート）にアクセスする。

### 3.1. 経費登録機能 (F001)

#### 3.1.1. 単一経費登録 (F001-01)
**概要**: 個別の経費を手動で登録する  
**実装**: ExpenseApp.js registerExpense()メソッド

**入力項目**:
| 項目名 | 型 | 必須 | 長さ制限 | 検証ルール |
|--------|----|----|----------|------------|
| タイトル | 文字列 | 必須 | 1-100文字 | XSSサニタイズ（ValidationService） |
| 種別 | 選択肢 | 必須 | - | CONSTANTS.EXPENSE_TYPES |
| 金額 | 数値 | 必須 | 1-10,000,000 | 正の整数、NumberFormat |
| 日付 | 日付 | 必須 | - | 有効な日付形式（ISO 8601） |
| 備考 | 文字列 | 任意 | 0-500文字 | XSSサニタイズ |

**成功条件**:
- データが正常にLocalStorageに保存される
- 6桁の一意なコード（YYMMDD + 連番）が自動生成される
- ダッシュボードのメトリクスがリアルタイム更新される
- 成功メッセージが表示される

#### 3.1.2. 一括経費登録 (F001-02)
**概要**: CSVファイルから複数の経費を一括登録する  
**実装**: ExpenseApp.js importFromCSV()メソッド

**CSV仕様**:
- **ファイル形式**: CSV (UTF-8 BOM付き推奨)
- **ファイルサイズ**: 最大5MB
- **必須列**: タイトル、種別、金額、日付
- **オプション列**: 備考
- **ヘッダー行**: 必須

## 4. 機能要件

`index.html`に定義されたUI要素に基づき、以下の機能要件を定義する。

-   **FR-1: ページナビゲーション**
    -   **要件**: ヘッダーのナビゲーションリンク（ホーム、経費登録、経費一覧、レポート）をクリックすることで、対応するページ（`<div class="page">`）が表示されること。
    -   **実装**: `onclick="appController.showPage(...)`"
-   **FR-2: 経費登録**
    -   **要件**: 「経費登録」ページから「1件ずつ登録」を選択し、フォーム（タイトル、種別、金額、備考）に入力して経費を登録できること。
    -   **実装**: `<form id="expense-form">`
-   **FR-3: 一括登録**
    -   **要件**: 「一括で登録」ボタンからCSVファイルを選択し、複数の経費データをインポートできること。
    -   **実装**: `<input type="file" id="expense-file-upload">`
-   **FR-4: 経費一覧表示**
    -   **要件**: 登録済みの経費がテーブル形式で一覧表示されること。テーブルの各列ヘッダーをクリックしてソートできること。
    -   **実装**: `<table class="expense-table">`
-   **FR-5: データのエクスポートと削除**
    -   **要件**: 一覧画面のボタンから、全経費データをCSVとしてダウンロード、または全データを削除できること。
-   **FR-6: レポート表示**
    -   **要件**: 「レポート」ページで、月別経費推移（折れ線グラフ）と種別別内訳（円グラフ）が表示されること。
    -   **実装**: `<canvas id="monthlyChart">`, `<canvas id="categoryChart">`

### 4.1. 経費管理機能 (F002)

#### 4.1.1. 経費一覧表示 (F002-01)
**概要**: 登録済み経費の一覧を表示する  
**実装**: VirtualScrollManager + ChartManager

**表示項目**: コード、日付、タイトル、種別、金額、ステータス、操作ボタン  
**機能**:
- **仮想スクロール**: 1000件以上のデータ高速表示
- **ソート機能**: 全列対応（昇順・降順）
- **フィルタリング**: 種別・ステータス・日付範囲
- **ページネーション**: 20件/ページ（仮想スクロール併用）
- **リアルタイム検索**: デバウンス処理（300ms）

#### 4.1.2. 経費編集 (F002-02)
**概要**: 既存経費の情報を変更する  
**制約**:
- コード・作成日時は変更不可
- 処理済みステータスの経費は編集不可
- 楽観的ロック（LocalStorage更新チェック）

#### 4.1.3. 経費削除 (F002-03)
**概要**: 不要な経費を削除する  
**処理**:
- 論理削除（deleted フラグ設定）
- 確認ダイアログ必須
- 30日間復旧可能

### 4.2. データ管理機能 (F003)

#### 4.2.1. CSVエクスポート (F003-01)
**概要**: 経費データをCSV形式で出力する  
**出力形式**:
- **文字エンコード**: UTF-8 BOM付き
- **区切り文字**: カンマ
- **改行コード**: CRLF（Windows互換）
- **ファイル名**: expense_YYYYMMDD_HHMMSS.csv

#### 4.2.2. データバックアップ (F003-02)
**概要**: LocalStorageデータの自動・手動バックアップ  
**機能**:
- **自動バックアップ**: 1時間毎
- **手動バックアップ**: ユーザー操作
- **復旧機能**: バックアップからの復元
- **圧縮**: JSON.stringify + 圧縮アルゴリズム

### 4.3. レポート・分析機能 (F004)

#### 4.3.1. ダッシュボード (F004-01)
**概要**: 経費データの要約情報をリアルタイム表示  
**表示項目**:
- **経費総額**: 当月・前月・年累計
- **件数統計**: 今月登録件数・処理済み件数
- **月次推移**: 折れ線グラフ（Chart.js）
- **種別別集計**: 円グラフ（Chart.js）

## 5. 非機能要件

-   **NFR-1 (セキュリティ)**: `index.html`に`Content-Security-Policy`を`meta`タグで設定し、XSS等の攻撃を緩和する。
-   **NFR-2 (パフォーマンス)**: JavaScriptは`type="module"`で読み込み、`DOMContentLoaded`イベント後に初期化処理を実行することで、ページの表示パフォーマンスを最適化する。
-   **NFR-3 (互換性)**: ES6モジュールをサポートするモダンブラウザ（Chrome, Firefox, Edgeの最新版）で正常に動作すること。

### 5.1. 性能要件

#### 5.1.1. 応答時間
| 機能 | 目標時間 | 実績 | 測定条件 |
|------|----------|------|----------|
| ページ読み込み | 1秒以内 | 0.8秒 | 初回アクセス |
| 経費登録 | 0.5秒以内 | 0.3秒 | 単一データ |
| 一覧表示 | 1秒以内 | 0.5秒 | 1000件データ |
| グラフ描画 | 2秒以内 | 1.2秒 | Chart.js初期化 |

#### 5.1.2. メモリ使用量
- **LocalStorage**: 最大10MB（警告5MB、制限8MB）
- **ブラウザメモリ**: 最大512MB（1000件データ表示時）
- **仮想スクロール**: DOM要素数50個以下に制限

#### 5.1.3. データ処理量
- **CSV一括登録**: 最大5,000件/回
- **同時表示**: 1,000件（仮想スクロール）
- **グラフ描画**: 12ヶ月分のデータ

### 5.2. セキュリティ要件

#### 5.2.1. セッション管理
- **セッションタイムアウト**: 30分間
- **非アクティブ検知**: 15分間
- **自動ログアウト**: タイムアウト時の自動データ保存

### 5.3. 可用性要件

#### 5.3.1. 稼働率
- **目標稼働率**: 99%以上
- **メンテナンス時間**: 月次1時間以内
- **障害復旧時間**: 30分以内

### 5.4. 保守性要件

#### 5.4.1. コード品質
- **ESLint**: 警告0件、エラー0件
- **モジュール結合度**: 低結合・高凝集
- **コメント率**: 30%以上
- **関数複雑度**: 15以下

#### 5.4.2. ドキュメント
- **JSDoc**: 全public メソッド
- **README**: 環境構築・実行手順
- **API仕様書**: 全機能の入出力仕様

## 6. データ要件

-   **データストレージ**: 全ての経費データは、クライアントのブラウザ内の`LocalStorage`にJSON形式で保存される。
-   **データスキーマ**: 経費データは、タイトル, 種別, 金額, 備考, コード, ステータス, 登録日といったキーを持つオブジェクトとして管理される。

### 6.1. データモデル
// 経費データ構造
const ExpenseSchema = {
    id: 'string',           // YYMMDD + 3桁連番
    title: 'string',        // 経費タイトル
    category: 'string',     // 種別（CONSTANTS.EXPENSE_TYPES）
    amount: 'number',       // 金額（整数）
    date: 'string',         // 日付（ISO 8601形式）
    description: 'string',  // 備考
    status: 'string',       // ステータス（pending/processed/rejected）
    createdAt: 'string',    // 作成日時
    updatedAt: 'string',    // 更新日時
    deleted: 'boolean'      // 削除フラグ
};

// LocalStorage キー構造
const StorageKeys = {
    EXPENSES: 'expenses',
    SETTINGS: 'settings',
    BACKUP: 'backup',
    ERRORS: 'errorLogs'
};

### 6.2. データ整合性
- **一意性制約**: ID（YYMMDD + 3桁連番）
- **参照整合性**: 種別マスタ参照
- **データ検証**: 保存時・読み込み時の二重チェック

## 7. 外部インターフェース要件

-   **IF-1 (CDN)**: `Chart.js`ライブラリおよび`Google Fonts`（Orbitron, Rajdhani）をCDN経由で読み込む。

### 7.1. ユーザーインターフェース

#### 7.1.1. アクセシビリティ
- **WAI-ARIA**: 適切なaria-label、role属性
- **キーボード操作**: Tab順序、Enter/Spaceキー対応
- **スクリーンリーダー**: 代替テキスト、構造化マークアップ

## 8. 運用・保守要件

-   **運用**: 本アプリケーションは静的ファイルで構成されるため、任意のHTTPサーバー上でホスティング可能。

### 8.1. 技術制約
- **フレームワーク**: 外部フレームワーク不使用（Vanilla JavaScript）
- **データベース**: LocalStorageのみ使用（SQLサーバー不使用）
- **ネットワーク**: CDN以外はオフライン動作
- **ブラウザ**: ES6モジュール対応必須

### 8.2. 業務制約
- **シングルユーザー**: 同時複数ユーザー不対応
- **データ容量**: LocalStorage 10MB制限
- **処理件数**: 単一操作最大5,000件

### 8.3. 運用制約
- **稼働時間**: 24時間365日（ブラウザ依存）
- **メンテナンス**: アプリケーション更新時のみ
- **バックアップ**: ローカルバックアップ機能のみ

## 9. 制約条件・前提条件・依存関係

-   **制約**: `file://`プロトコルでの直接実行は不可。HTTPサーバー環境が必須。
-   **開発依存関係**: ローカルでの動作確認には VS Code の Live Server を推奨する（`index.html` を Live Server で開いて動作確認してください）。

### 9.1. 機能受け入れ条件
| 機能 | 受け入れ条件 | テスト方法 |
|------|-------------|-----------|
| **経費登録** | エラーなく保存され、一覧に表示される | 手動テスト |
| **CSV一括登録** | 5,000件のCSVが5秒以内で登録される | パフォーマンステスト |
| **検索・フィルタ** | 1,000件データから即座に絞り込まれる | 自動テスト |
| **グラフ表示** | Chart.jsで正確なデータが可視化される | 視覚確認テスト |

### 9.2. 性能受け入れ条件
| 項目 | 受け入れ条件 | 測定方法 |
|------|-------------|----------|
| **応答時間** | 全操作1秒以内 | ブラウザDevToolsで測定 |
| **セキュリティ** | XSS攻撃テストで脆弱性0件 | セキュリティスキャン |
| **ブラウザ互換性** | Chrome/Firefox/Edge/Safariで同一動作 | マルチブラウザテスト |
| **メモリ使用量** | 1,000件表示時512MB以下 | メモリプロファイラで測定 |

### 9.3. 品質受け入れ条件
- **ESLint**: 警告・エラー0件
- **JSDoc**: カバレッジ90%以上
- **テストカバレッジ**: 機能テスト95%以上
- **パフォーマンス**: Lighthouse スコア90以上

### 9.4. 運用受け入れ条件
- **インストール**: 5分以内でセットアップ完了
- **操作習得**: 新規ユーザーが30分以内で基本操作習得
- **データ移行**: 既存Excelから一括移行が1時間以内
- **バックアップ**: 手動バックアップが1分以内に完了

## 10. トレーサビリティ

### 10.1. テスト種別
| テスト種別 | 目的 | 実施者 | 実施時期 |
|------------|------|--------|----------|
| **単体テスト** | 個別関数・メソッドの動作確認 | 開発者 | 実装中 |
| **結合テスト** | モジュール間連携の確認 | 開発者 | 実装完了後 |
| **システムテスト** | 要件通りの動作確認 | QAエンジニア | 結合テスト後 |
| **受け入れテスト** | ユーザー観点での動作確認 | ユーザー代表 | システムテスト後 |

## 11. 用語集

-   **SPA (Single Page Application)**: 単一のHTMLページで動作し、ページ遷移をJavaScriptで動的に処理するWebアプリケーションのアーキテクチャ。
-   **CSP (Content Security Policy)**: Webサイトが読み込むリソースを制限することで、セキュリティを向上させる仕組み。
