# 電力需要予測AIモデル構築 - 使用手順書 v2.0

※ この資料は教育用のサンプルです。

**バージョン**: v2.0  
**リリース日**: 2025年10月15日  
**主要特性**: CLI + Webダッシュボード統合版

---

## 1. システム概要

本システムは、Pythonベースの機械学習・深層学習環境で動作する。v2.0では、**従来のCLI操作に加え、Webダッシュボードによるブラウザ操作**を提供する。

### 1.1. 適用範囲と前提
本手順書は、VS CodeとPythonを使用した開発環境のセットアップ、および電力需要予測AIモデルの実行方法（CLI・WebUI両方）について記述する。

#### 1.1.1. VS Code
- 推奨バージョン: 最新安定版（定期更新推奨）
- 対象OS: Windows 10/11（PowerShell使用）
- インストール元: [VS Code公式サイト](https://code.visualstudio.com/)

#### 1.1.2. Python
- 推奨バージョン: 3.10.11（全プロジェクト統一、v1.0と同一）
- インストール元: [python.org 公式サイト](https://www.python.org/downloads/release/python-31011/)
    Filesの「Windows installer (64-bit)」をクリックしてインストーラー（python-3.10.11-amd64.exeファイル）をダウンロードする。

#### 1.1.3. Webブラウザ（v2.0新規）
- 推奨ブラウザ: Chrome/Firefox/Edge最新版
- Webダッシュボード用（ダークモード対応、HTML5/CSS3標準準拠）

## 2. 動作環境

### 2.1. 環境セットアップ

#### 2.1.1. VS Codeでフォルダを開く

1.  VS Codeを起動する。
2.  `Ctrl + K, Ctrl + O` または「ファイル」→「フォルダーを開く」を選択する。
3.  以下のパスを指定して開く（要注意！）。
    `C:\Users\<UserName>\<project_root>\05_電力需要予測AIモデル構築\AI`

#### 2.1.2. PowerShellターミナルを開く

1. VS Codeで `Ctrl + Shift + P` を押す。
2. 「Terminal: Create New Terminal」を選択する。
3. ターミナルが表示されることを確認する。

#### 2.1.3. Python環境設定

```powershell
# Python バージョン確認（3.10.11必須）
py -3.10 --version
# 結果例: Python 3.10.11

# 仮想環境作成（推奨・Python 3.10.11指定）
py -3.10 -m venv .venv

# 仮想環境を有効化
.\.venv\Scripts\Activate.ps1
# コマンドライン先頭に (.venv) が表示されることを確認

# 仮想環境Python バージョン確認（3.10.11必須）
.\.venv\Scripts\python.exe --version
# 結果例: Python 3.10.11
```

#### 2.1.4. VS Code Pythonインタープリターの選択

1. `Ctrl+Shift+P`でコマンドパレットを開く
2. 「Python: Select Interpreter」と入力して選択する
3. 作成した仮想環境の`.venv\Scripts\python.exe` を選択する

## 3. インストール/セットアップ手順

### 3.1. pip自体の最新化
```powershell
py -3.10 -m pip install --upgrade pip
```

### 3.2. 全モデル対応の完全版インストール（v1.0と同一）
```powershell
pip install -r requirements.txt
```

**v2.0での変更**: なし（requirements.txtはv1.0と完全同一、追加ライブラリなし）

環境をリセットしたい場合は、`.venv`フォルダを削除する

## 4. 初期設定

- 学習用データ（例: `juyo-YYYY.csv`, `temperature-YYYY.csv`）を`AI/data`フォルダに配置する
- 予測対象のデータ（例: `tomorrow.csv`）を`AI/tomorrow`フォルダに配置する

## 5. 基本操作

### 5.1. v2.0推奨: Webダッシュボード操作（初心者向け）

#### 5.1.1. HTTPサーバー起動

##### 5.1.1.1. デフォルトポート（8002）での起動
```powershell
# AIフォルダで実行
py -3.10 server.py
```

**実行結果**:
```
サーバー起動: http://localhost:8002/
ブラウザが自動起動します...
```

##### 5.1.1.2. カスタムポートでの起動
```powershell
# 環境変数でポート番号変更（例: 8003）
$env:AI_SERVER_PORT = "8003"
py -3.10 server.py
```

#### 5.1.2. Webダッシュボード操作

##### 5.1.2.1. ダッシュボード画面構成
ブラウザが自動起動し、以下の画面が表示される:

```text
┌─────────────────────────────────────┐
│ 電力需要AI予測ダッシュボード v2.0      │
├───────┬───────┬───────┬──────────────┤
│モデル │ 予測  │ 学習  │ 学習年       │
│選択   │カード │カード │カード        │
│       │       │       │              │
│[Keras]│[最新  │[データ│[2022]        │
│[Light-│ データ│ 処理] │[2023]        │
│GBM]   │ 取得] │[学習] │[2024]        │
│[PyC   │[予測] │       │              │
│aret]  │       │       │              │
│[Rand  │       │       │              │
│Forest]│       │       │              │
├───────┴───────┴───────┴──────────────┤
│ 予測グラフエリア  │ 学習グラフエリア│
│ (16:9)         │ (16:9)        │
│                 │                │
│ [グラフ自動表示] │ [グラフ自動表示]│
└────────────────────┴─────────────────┘
```

##### 5.1.2.2. モデル学習実行手順（例: LightGBM、2022-2024年）
**所要時間**: 約9秒（v1.0: 約110秒 → **92%削減**）

1. **モデル選択** (1秒)
   - [LightGBM]ボタンをクリック
   - ボタンが緑ネオン発光で選択状態を表示

2. **学習年選択** (3秒)
   - [2022][2023][2024]ボタンを順にクリック
   - 選択したボタンが緑ネオン発光

3. **データ処理実行** (1秒 + バックグラウンド実行)
   - [データ処理]ボタンをクリック
   - 実行中は緑ネオン発光アニメーション
   - バックグラウンドで`data.py`が実行される

4. **学習実行** (1秒 + バックグラウンド実行)
   - [学習]ボタンをクリック
   - 実行中は緑ネオン発光アニメーション
   - バックグラウンドで`LightGBM_train.py`が実行される

5. **結果自動表示** (5秒)
   - 学習完了後、グラフが自動表示される
   - RMSE/R2/MAE指標が自動更新される
   - グラフクリックで拡大表示（モーダルウィンドウ）

##### 5.1.2.3. 翌日予測実行手順（例: LightGBM）
**所要時間**: 約7秒（v1.0: 約90秒 → **92%削減**）

1. **モデル選択** (1秒)
   - [LightGBM]ボタンをクリック

2. **最新データ取得** (1秒 + バックグラウンド実行)
   - [最新データ取得]ボタンをクリック
   - 実行中は緑ネオン発光アニメーション
   - バックグラウンドで`data.py` + `temp.py`が実行される

3. **予測実行** (1秒 + バックグラウンド実行)
   - [予測]ボタンをクリック
   - 実行中は緑ネオン発光アニメーション
   - バックグラウンドで`LightGBM_tomorrow.py`が実行される

4. **予測結果自動表示** (5秒)
   - 予測完了後、グラフが自動表示される
   - グラフクリックで拡大表示
   - ダウンロードボタンでPNG保存

##### 5.1.2.4. モデル切替（例: LightGBM → RandomForest）
**所要時間**: 約2秒（v1.0: 約30秒 → **93%削減**）

1. **モデル選択** (1秒)
   - [RandomForest]ボタンをクリック
   - 前回選択の[LightGBM]ボタンが自動的に非選択状態になる

2. **学習実行** (1秒)
   - [学習]ボタンをクリック
   - 学習年選択は前回の状態を保持

3. **結果自動表示**
   - RandomForestの学習結果が自動表示される

#### 5.1.3. 実行履歴確認（server.log）

##### 5.1.3.1. ログファイル確認
```powershell
# server.logを表示
Get-Content server.log
```

##### 5.1.3.2. ログ内容例
```
2025-10-15 10:30:15 - POST /run-data - model: LightGBM, years: [2022, 2023, 2024]
2025-10-15 10:30:45 - subprocess: data.py - 実行時間: 30秒
2025-10-15 10:30:45 - POST /run-train - model: LightGBM, years: [2022, 2023, 2024]
2025-10-15 10:35:20 - subprocess: LightGBM_train.py - 実行時間: 275秒
2025-10-15 10:35:20 - 学習完了: RMSE=152.6, R2=0.95
```

##### 5.1.3.3. ログローテーション
server.logが10MB超過時、自動的にserver.log.1, server.log.2, ...にバックアップされる。

### 5.2. v1.0互換: CLI操作（技術者向け）

#### 5.2.1. データ前処理・学習フェーズ

##### 5.2.1.1. データ前処理実行
```powershell
# 電力需要・気温データの統合処理（全年）
py -3.10 .\data\data.py

# 特定年のみ処理（v2.0新機能: コマンドライン引数）
py -3.10 .\data\data.py 2022,2023,2024
```

##### 5.2.1.2. 各種AIモデル学習実行
```powershell
# Keras深層学習モデル（ニューラルネットワーク）
py -3.10 .\train\Keras\Keras_train.py

# v2.0新機能: 学習年指定
py -3.10 .\train\Keras\Keras_train.py 2022,2023,2024

# LightGBM勾配ブースティングモデル
py -3.10 .\train\LightGBM\LightGBM_train.py 2022,2023,2024

# PyCaret自動機械学習モデル
py -3.10 .\train\Pycaret\Pycaret_train.py 2022,2023,2024

# RandomForestアンサンブルモデル
py -3.10 .\train\RandomForest\RandomForest_train.py 2022,2023,2024
```

##### 5.2.1.3. 環境変数による年指定（v2.0新機能）
```powershell
# 環境変数AI_TARGET_YEARSで学習年指定
$env:AI_TARGET_YEARS = "2022,2023,2024"

# データ処理実行（環境変数から年取得）
py -3.10 .\data\data.py

# モデル学習実行（環境変数から年取得）
py -3.10 .\train\LightGBM\LightGBM_train.py
```

#### 5.2.2. 翌日予測フェーズ（v1.0と同一）

##### 5.2.2.1. 最新データ取得
```powershell
# TEPCO電力需要実績データ取得
py -3.10 .\tomorrow\data.py

# Open-Meteo API気温データ取得
py -3.10 .\tomorrow\temp.py
```

##### 5.2.2.2. 各種AIモデル翌日予測実行
```powershell
# Keras翌日予測実行
py -3.10 .\tomorrow\Keras\Keras_tomorrow.py

# LightGBM翌日予測実行
py -3.10 .\tomorrow\LightGBM\LightGBM_tomorrow.py

# PyCaret翌日予測実行
py -3.10 .\tomorrow\Pycaret\Pycaret_tomorrow.py

# RandomForest翌日予測実行
py -3.10 .\tomorrow\RandomForest\RandomForest_tomorrow.py
```

## 6. 高度な操作

### 6.1. 環境変数設定（v2.0新機能）

#### 6.1.1. AI_TARGET_YEARS（学習年指定）
```powershell
# 単一年指定
$env:AI_TARGET_YEARS = "2024"

# 複数年指定（カンマ区切り）
$env:AI_TARGET_YEARS = "2022,2023,2024"

# 環境変数確認
echo $env:AI_TARGET_YEARS
```

#### 6.1.2. AI_SERVER_PORT（HTTPサーバーポート変更）
```powershell
# デフォルト（8002）から変更
$env:AI_SERVER_PORT = "8003"

# サーバー起動
py -3.10 server.py
# サーバー起動: http://localhost:8003/
```

### 6.2. バッチ実行（複数モデル連続実行）

#### 6.2.1. CLI版バッチ実行
```powershell
# 全モデル学習バッチ（2022-2024年）
py -3.10 .\data\data.py 2022,2023,2024
py -3.10 .\train\Keras\Keras_train.py 2022,2023,2024
py -3.10 .\train\LightGBM\LightGBM_train.py 2022,2023,2024
py -3.10 .\train\Pycaret\Pycaret_train.py 2022,2023,2024
py -3.10 .\train\RandomForest\RandomForest_train.py 2022,2023,2024
```

#### 6.2.2. WebUI版バッチ実行
1. [Keras]ボタンをクリック
2. [2022][2023][2024]ボタンをクリック
3. [データ処理]→[学習]をクリック（Keras完了）
4. [LightGBM]ボタンをクリック
5. [学習]をクリック（LightGBM完了）
6. 同様にPyCaret、RandomForestを実行

### 6.3. トラブルシューティング

#### 6.3.1. HTTPサーバー起動失敗
**症状**: `OSError: [WinError 10048] 通常、各ソケット アドレスに対してプロトコル、ネットワーク アドレス、またはポートのどれか 1 つのみを使用できます。`

**原因**: ポート8002が既に使用中

**解決策**:
```powershell
# ポート番号を変更
$env:AI_SERVER_PORT = "8003"
py -3.10 server.py
```

#### 6.3.2. ブラウザが自動起動しない
**症状**: サーバー起動メッセージは表示されるが、ブラウザが開かない

**解決策**: 手動でブラウザを開き、`http://localhost:8002/`にアクセス

#### 6.3.3. グラフが表示されない
**症状**: 学習完了後、グラフエリアが空白

**原因**: PNGファイルが生成されていない、またはパスが間違っている

**解決策**:
```powershell
# モデルフォルダを確認
ls .\train\LightGBM\*.png

# ファイルが存在しない場合は再学習
py -3.10 .\train\LightGBM\LightGBM_train.py
```

#### 6.3.4. 環境変数が反映されない
**症状**: 環境変数AI_TARGET_YEARSを設定しても全年処理される

**原因**: PowerShellセッション内でのみ有効

**解決策**: 同一PowerShellセッション内で実行
```powershell
# 同一セッション内で実行
$env:AI_TARGET_YEARS = "2022,2023,2024"
py -3.10 .\data\data.py
```

#### 6.3.5. タイムアウトエラー
**症状**: `subprocess.TimeoutExpired: タイムアウト: 40分経過しました`

**原因**: 学習時間が40分を超えた

**解決策**: `server.py`のタイムアウト設定を変更
```python
# server.py の該当行を修正
result = subprocess.run(
    ['python', 'train.py'],
    timeout=3600  # 40分→60分に変更
)
```

## 7. 付録

### 7.1. ショートカット
- `Ctrl + K, Ctrl + O`: フォルダーを開く
- `Ctrl + Shift + P`: コマンドパレット
- `Ctrl+Shift+P`: Python インタープリター選択

### 7.2. 推奨ワークフロー

#### 7.2.1. 初回セットアップ（1回のみ）
1. Python 3.10.11インストール
2. VS Codeインストール
3. 仮想環境作成（`.venv`）
4. `pip install -r requirements.txt`

#### 7.2.2. 日常的なモデル学習（WebUI推奨）
1. `py -3.10 server.py`でサーバー起動
2. ブラウザでダッシュボード操作
3. モデル選択→年選択→学習実行
4. 結果自動表示で確認

#### 7.2.3. 詳細分析・デバッグ（CLI推奨）
1. 環境変数`AI_TARGET_YEARS`設定
2. CLIで個別スクリプト実行
3. ログ詳細確認
4. 必要に応じてコード修正・再実行

### 7.3. v1.0 → v2.0移行ガイド

#### 7.3.1. 既存v1.0ユーザー向け
- **v1.0のCLI操作はそのまま使用可能**（下位互換性100%）
- WebUIを試したい場合は、`py -3.10 server.py`でサーバー起動のみ追加
- 環境変数`AI_TARGET_YEARS`は任意（従来のコマンドライン引数も継続サポート）

#### 7.3.2. 新規v2.0ユーザー向け
- **WebUI操作を推奨**（学習コスト75%削減、操作時間92%削減）
- 初回はCLIで環境セットアップ（仮想環境作成、pip install）
- 以降はWebUIで日常的なモデル学習・予測を実行

---
