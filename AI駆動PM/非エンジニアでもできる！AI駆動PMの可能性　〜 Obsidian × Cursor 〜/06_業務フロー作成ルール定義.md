## 1. 目的

本ルールは、Cursorエディタ環境において、Mermaid記法を用いた**フローチャート**または**シーケンス図**のMarkdownプレビュー表示が不安定であるという制約を考慮し、**安定して表示可能な範囲内**で業務フローを記述・共有するための標準的な方法を定めることを目的とする。記述する前に**最適な図の種類を選択**し、可能な限り処理の流れ、役割間の相互作用、担当者（5W1Hの一部）を明確にすることを目指す。

---

## 2. 前提条件

* **エディタ:** Cursor
* **ファイル形式:** Markdown (`.md`)
* **Mermaid拡張機能:** `Markdown Preview Mermaid Support` (v1.28.0 / Mermaid.js v11.6.0 相当) がインストールされ、有効になっていること。
* **競合拡張機能:** `Markdown All in One`, `Markmap` など、Markdownプレビューに影響を与える可能性のある他の拡張機能は無効化されていること。

---

## 3. 最重要制約事項（厳守）

以下の制約は、Cursor環境でMermaid図（フローチャート、シーケンス図共通）を表示させるために**必ず守らなければならない**。

* **(a) コードブロック:** Mermaidコードは必ず ```mermaid ... ``` で囲む。
* **(b) 図の規模:** 1つの図に含まれる主要な要素（ノード/エッジ、参加者/メッセージ）の数を**15個程度以下**に抑える（複雑な場合は図を分割するか、補足テキストで詳述）。
* **(c) テキスト記号制限:** ノードテキスト、ラベル、メッセージ、参加者名などには、**`:` `@` `()` などの特殊記号を使用しない**。**シンプルな日本語、英数字、Mermaidで必須の括弧（`[]`, `{}`）のみ**とする。
* **(d) コメント禁止:** Mermaidコードブロック内に **`%%` コメントを記述しない**。

---

## 4. 基本方針

* 業務フローで表現したい内容に合わせて、**まず最適な図の種類（フローチャート or シーケンス図）を選択する**（下記5. 参照）。
* 上記3. の制約を最優先し、Mermaid図は**フローの骨格、主要な流れ、役割間の基本的なやり取り**を示すものと位置づける。
* Mermaid図だけでは表現できない詳細情報（**場所・システム(Where)、方法・手段(How)、詳細な条件(Why/When)、詳細な役割(Who)** など）は、**必ずMarkdown本文のテキスト、リスト、表などで補足する**。

---

## 5. 図の種類の選択基準

業務フローのどの側面を強調したいかによって、使用する図を選択する。

### 5.1. フローチャートが適している場合
* 個々の**処理手順**や**作業のステップ**を詳細に示したい場合。
* **複雑な条件分岐**や複数の選択肢がある意思決定プロセスを明確に図示したい場合。
* プロセス全体の**構造**や流れを俯瞰的に捉えたい場合。

### 5.2. シーケンス図が適している場合
* **部署間、担当者間、システム間の連携や相互作用**（メッセージの送受信、処理の依頼、応答など）を時系列で明確に示したい場合。
* **誰が、いつ、どの役割/システムに働きかけるか**という情報の流れを重視する場合。
* 特定のシナリオにおける役割間のコミュニケーションを追跡したい場合。

### 5.3. 組み合わせ利用
* 業務フロー全体の大まかな流れをフローチャートで示し、特定の部署間連携など、詳細な相互作用を示したい部分について別途シーケンス図で補足するなど、両者を組み合わせて利用することも有効。

---

## 6. Mermaid記述ルール詳細

### 6.1. 共通ルール
* **コードブロック:** 必ず ```mermaid ... ``` で囲む。（制約a）
* **規模:** 1図あたり主要要素15個程度以下。（制約b）
* **テキスト記号制限:** 特殊記号（`:` `@` `()`等）不使用。シンプルな日本語/英数字のみ。（制約c）
* **コメント禁止:** `%%` コメント不使用。（制約d）

### 6.2. フローチャート (`graph`) 記述ルール
* **図の宣言:** `graph TD` または `graph LR` （実績のある方）を使用。
* **ノード定義 (`A[...]`, `B{...}`):** IDは短い英数字。テキストは具体的・簡潔に。担当者はテキスト先頭 or IDプレフィックスで（記号 `:` 不使用）。
* **矢印定義 (`-->`):** 基本的な矢印推奨。ラベルはシンプルなテキストのみ。
* **分岐 (`{}`):** ノードテキストとシンプルな矢印ラベルで表現。
* **`subgraph`:** 使用する場合は**厳格な形式**（ID列挙は改行区切り、ノード/矢印定義は外）のみ。
    * 例:
        ```mermaid
        graph TD
            A --> B;
            C --> D;
            subgraph MySub
                A
                C
            end
        ```

### 6.3. シーケンス図 (`sequenceDiagram`) 記述ルール
* **図の宣言:** `sequenceDiagram` を使用。
* **参加者 (`participant`):** `participant 役割名` または `participant Alias as 役割名` で定義。名前はシンプルな日本語/英数字。
* **メッセージ (`->>`, `-->` 等):** 矢印とメッセージテキストで表現。テキストは具体的・簡潔に。記号制限を守る。
* **自身の処理:** `役割名->>役割名: 処理内容` で表現可。
* **高度な構文 (`alt`, `opt`, `loop`, `note`):** まずは使用せずに試す。使用する場合も極力シンプルに記述し、表示確認を行う。

---

## 7. 補足情報の記述 (必須)

Mermaid図の種類に関わらず、図だけでは不足する情報は**必ずMarkdown本文で補足する**。
* 担当詳細(Who)、場所/システム(Where)、方法/手段(How)、タイミング/期限(When)、条件/理由(Why)、コードの説明など。
* 例: 表形式での補足
    | ステップID | 担当部署 | 使用システム | 補足説明                     |
    | :--------- | :------- | :----------- | :--------------------------- |
    | A          | サポート | ヘルプデスク | メールを受信                 |
    | B          | サポート | ヘルプデスク | 内容を確認、緊急度も判断     |
    | C          | サポート | ヘルプデスク | 技術チームへメール機能で転送 |
    | ...        | ...      | ...          | ...                          |

---

## 8. 推奨事項

* **一貫性:** ルール内で定義した表記（担当者の書き方など）を一貫して使用する。
* **シンプルさ:** 無理にMermaid図に情報を詰め込まず、補足情報を活用する。
* **レビュー:** 作成したMarkdownファイルを他の人が見て理解できるかレビューを行う。
* **代替案の判断:** このルールを守っても表示されない場合や、表現力が不足する場合は、無理せず代替案（Mermaid Live Editorで作成した画像を貼り付けるなど）に切り替える。

---

## 9. コード例

以下に、本ルールに準拠したMermaidコードの例を示します。**そのままコピーして `.md` ファイルに貼り付けて使用できます。**

### フローチャート例 (受付フェーズ)
```mermaid
graph TD
    A[サポート問合せ受信] --> B{サポート内容確認判断};
    B -- 技術関連 --> C[サポート技術チームへ転送];
    B -- 営業関連 --> D[サポート営業チームへ転送];

    subgraph UketsukePhase
        A
        B
        C
        D
    end