# 電力需要予測AIモデル構築 - 要件定義書 v3.0

※ この資料は教育用のサンプルです。

**バージョン**: v3.0  
**リリース日**: 2025年10月25日  
**主要特性**: CLI + Webダッシュボード + 組み合わせ検証統合版

---

## 1. ビジネス要件

### 1.1. 目的・背景
電力需要の高精度予測を通じた電力安定供給とエネルギー効率最適化の実現である。機械学習技術を活用した4種類のアルゴリズム（Keras、LightGBM、PyCaret、RandomForest）による包括的予測システムに加え、**Webダッシュボードによる視覚的操作環境**および**組み合わせ検証機能（ローリング時系列交差検証）による科学的最適化**を提供し、電力需要管理の自動化・高度化・効率化・精度最大化を図る。

- **目的**: 過去の電力消費実績データを基に、将来の電力需要を高精度で予測するAIモデルを構築し、ブラウザベースのWebインターフェースにより技術者・非技術者を問わず直感的な操作を可能にし、**最適な学習年組み合わせを自動探索する組み合わせ検証機能**により予測精度を最大化する
- **KPI**: 予測精度（例: 平均絶対パーセント誤差 MAPE）を目標値以下に抑え、操作時間を50%削減、学習コストを75%削減、**組み合わせ検証により精度を17.6%向上、最適化時間を86-95%削減**する

### 1.2. 適用範囲
- **対象領域**: 東京電力管内の電力需要予測
- **データ範囲**: 2016年～2025年の電力需要実績・気温データ
- **予測精度目標**: RMSE < 200kW、R2スコア > 0.9
- **処理性能目標**: メモリ使用量50%削減、学習時間30%短縮
- **操作性目標（v2.0）**: CLI操作時間97%削減、結果確認時間92%削減、モデル切替時間93%削減
- **精度最適化目標（v3.0）**: RMSE改善率17.6%、組み合わせ検証時間86-95%削減、成功率100%

### 1.3. 利用者
| 利用者 | 役割 | 利用目的 | v2.0での利点 | v3.0での利点 |
|-------|------|----------|--------------|--------------|
| **電力オペレーター** | 電力供給管理 | 需要予測による発電計画策定 | WebUIで直感的操作 | 最適学習年で高精度予測 |
| **エネルギー分析者** | データ分析 | 需要パターン分析・レポート作成 | グラフ自動表示 | 組み合わせ検証結果の科学的分析 |
| **システム管理者** | 運用管理 | モデル性能監視・保守 | server.logで履歴確認 | 組み合わせ検証結果ファイルで最適化追跡 |
| **開発エンジニア** | システム開発 | モデル改善・機能拡張 | HTTPサーバー拡張容易 | 組み合わせ検証アルゴリズム改善 |
| **非技術者（v2.0）** | 予測実行 | ワンクリック予測実行 | コマンド不要 | ワンクリック最適化実行 |
| **データサイエンティスト（v3.0）** | 精度最適化 | 最適学習年探索 | - | 自動交差検証、科学的意思決定 |

## 2. 利用者・ステークホルダー

### 2.1. 機能要件

#### 2.1.1. データ処理機能（v1.0からの継承）

##### F001: データ取得機能
v2.0と完全同一（環境変数AI_TARGET_YEARS対応含む）。

##### F002: 特徴量エンジニアリング機能
v2.0と完全同一（コマンドライン引数対応含む）。

##### F003: データ分割機能
v2.0と完全同一。

#### 2.1.2. モデル学習機能（v1.0からの継承）

##### F004: Keras深層学習モデル (train/Keras/Keras_train.py)
v2.0と完全同一（環境変数・引数対応含む）。

##### F005: LightGBM勾配ブースティングモデル (train/LightGBM/LightGBM_train.py)
v2.0と完全同一（環境変数・引数対応含む）。

##### F006: PyCaret自動機械学習モデル (train/Pycaret/Pycaret_train.py)
v2.0と完全同一（環境変数・引数対応含む）。

##### F007: RandomForestアンサンブルモデル (train/RandomForest/RandomForest_train.py)
v2.0と完全同一（環境変数・引数対応含む）。

#### 2.1.3. 予測実行機能（v1.0からの継承）

##### F008: tomorrow予測データ取得機能 (tomorrow/data.py, tomorrow/temp.py)
v2.0と完全同一（透過的実行）。

##### F009: 各モデル予測実行機能 (tomorrow/*/tomorrow.py)
v2.0と完全同一（透過的実行）。

#### 2.1.4. 可視化・レポート機能（v1.0からの継承）

##### F010: 統一可視化機能
v2.0と完全同一（16:9統一、Webダッシュボード自動表示対応含む）。

##### F011: 性能監視・ログ機能
v2.0と完全同一（robust_model_operation、server.log自動記録含む）。

##### F012: 過去期間予測機能
v2.0と完全同一。

#### 2.1.5. Webインターフェース機能（v2.0からの継承）

##### F013: HTTPサーバー機能 (server.py)
v2.0の全機能を保持し、/run-optimize-yearsエンドポイントを追加。

**v3.0拡張内容**:
```python
# APIエンドポイント（v3.0追加）
POST /run-optimize-years    # 組み合わせ検証実行（★v3.0新規）

# v2.0からの継承エンドポイント
POST /run-data              # データ処理実行
POST /run-train             # モデル学習実行
POST /run-tomorrow-data     # 最新データ取得
POST /run-tomorrow          # 予測実行
GET  /available-years       # 利用可能年一覧
GET  /                      # ダッシュボード表示
```

##### F014: Webダッシュボード機能 (dashboard/index.html)
v2.0の全機能を保持し、組み合わせ検証ボタンを追加。

**v3.0拡張内容**:
```text
┌─────────────────────────────────────┐
│ 電力需要AI予測ダッシュボード v3.0      │
├───────┬───────┬───────┬──────────────┤
│モデル │ 予測  │ 学習  │ 学習年       │
│選択   │カード │カード │カード        │
│       │       │       │ [2022] ...   │
│       │       │       │ [組み合わせ  │  ← ★v3.0新規
│       │       │       │  検証シミュ  │
│       │       │       │  レーション] │
├───────┴───────┴───────┴──────────────┤
│ 予測グラフエリア  │ 学習グラフエリア│
└────────────────────┴─────────────────┘
```

**v3.0追加機能**:
- **組み合わせ検証ボタン**: マゼンタ系発光、実行中アニメーション
- **ツールチップ**: 「選択したモデルで最適な組み合わせ学習年を検証します（※Kerasは十数分、それ以外は数分で処理）」
- **実行完了アラート**: 「組み合わせ検証終了」メッセージ
- **結果ファイル自動生成**: `YYYY-MM-DD_Model_optimize_years.txt`
- **メモ帳自動オープン**: 結果ファイルを自動表示
- **localStorage機能**: 学習年選択の永続化（ページリロード後も選択状態を保持）

##### F015: 環境変数連携機能
v2.0と完全同一（AI_TARGET_YEARS、AI_SERVER_PORT対応）。

##### F021: localStorage学習年記憶機能（v3.0新規）
- **目的**: ユーザーが選択した学習年の組み合わせをブラウザに保存し、ページリロード後も自動復元
- **保存キー**: `ai_training_years_${モデル名}`（モデル別記憶）
- **保存データ**: 選択された学習年の配列（JSON形式）
- **保存タイミング**:
  1. 学習年ボタンのクリック時（即座に保存）
  2. データ処理ボタン実行前
  3. 学習ボタン実行前
- **動作仕様**:
  1. **初回ロード時**: 保存データがない場合は全年選択（従来動作）
  2. **学習年選択時**: ボタンクリックで即座にlocalStorageに保存
  3. **学習/データ処理実行時**: 実行前に現在の選択状態を保存
  4. **モデル切り替え時**: 各モデル別に独立した学習年を自動復元
  5. **ページリロード時**: 自動的に学習年と視覚的状態を完全復元
- **実装の特徴**:
  - モデル別記憶: 各AIモデルで異なる学習年を個別に記憶
  - 即時保存: ボタンクリック時に即座に保存（学習実行を待たない）
  - 自動復元: ページリロード/モデル切り替え時に自動復元
  - 視覚的一貫性: ボタンのglow/inverted状態も完全保持
  - 後方互換性: localStorage非対応環境でもエラーなく動作
  - デバッグ対応: コンソールログで保存/復元内容を確認可能
- **実装コード例**:
  ```javascript
  // 保存処理
  function saveTrainingYears(model, years) {
      const key = `ai_training_years_${model}`;
      localStorage.setItem(key, JSON.stringify(years));
  }
  
  // 復元処理
  function loadTrainingYears(model) {
      const key = `ai_training_years_${model}`;
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : [];
  }
  ```
- **優先度**: P1 (高)

#### 2.1.6. 組み合わせ検証機能（v3.0新規）

##### F016: 組み合わせ生成機能 (*_optimize_years.py)
- **目的**: ローリング時系列交差検証の組み合わせ生成
- **対象モデル**: Keras, LightGBM, PyCaret, RandomForest（4ファイル）
- **実装仕様**:
  ```python
  def generate_rolling_combinations(self):
      """
      学習年の組み合わせローリング時系列交差検証の組み合わせ生成
      ユーザー要求: 全モデル高精度3年（2年学習→1年テスト）組み合わせ限定
      
      Returns:
          List[Tuple[List[int], int]]: (学習年リスト, テスト年)の組み合わせ
      
      例:
      - (2016,2017) → 2018
      - (2017,2018) → 2019
      - (2018,2019) → 2020
      - (2019,2020) → 2021
      - (2020,2021) → 2022
      - (2021,2022) → 2023
      - (2022,2023) → 2024
      合計: 7パターン
      """
      combinations_list = []
      for i in range(len(self.available_years) - 2):
          train_years = self.available_years[i:i+2]
          test_year = self.available_years[i+2]
          combinations_list.append((train_years, test_year))
      return combinations_list
  ```
- **出力**: 7組み合わせ（2年学習→1年テスト）
- **優先度**: P0 (最重要)

##### F017: 組み合わせ評価機能 (*_optimize_years.py)
- **目的**: 指定年組み合わせでモデル性能を評価
- **実装仕様**:
  ```python
  def evaluate_year_combination(self, train_years, test_year):
      """
      指定年組み合わせでモデル性能を評価
      
      実行フロー:
      1. 環境変数 AI_TARGET_YEARS 設定
      2. data.py 実行（データ処理）
      3. {Model}_train.py 実行（学習）
      4. stdout から RMSE, R2, MAE 抽出
      
      Returns:
          dict: {
              'train_years': [2016, 2017],
              'test_year': 2018,
              'rmse': 152.6,
              'r2': 0.9120,
              'mae': 100.4,
              'execution_time': 14.2
          }
      """
      env = os.environ.copy()
      env['AI_TARGET_YEARS'] = ','.join(map(str, train_years + [test_year]))
      
      # subprocess実行: data.py
      subprocess.run(['python', 'data.py'], env=env, timeout=600)
      
      # subprocess実行: train.py
      result = subprocess.run(['python', 'train.py'], env=env, 
                              capture_output=True, text=True, timeout=2400)
      
      # 結果解析: stdout から RMSE, R2, MAE 抽出
      rmse = extract_metric(result.stdout, 'RMSE')
      r2 = extract_metric(result.stdout, 'R2')
      mae = extract_metric(result.stdout, 'MAE')
      
      return {'train_years': train_years, 'test_year': test_year, 
              'rmse': rmse, 'r2': r2, 'mae': mae}
  ```
- **タイムアウト**: データ処理10分、学習40分
- **エラーハンドリング**: 例外捕捉、エラーログ記録
- **優先度**: P0 (最重要)

##### F018: 最適化実行機能 (*_optimize_years.py)
- **目的**: 組み合わせ年を最適化（メインロジック）
- **実装仕様**:
  ```python
  def optimize_years(self, target_metric="rmse"):
      """
      組み合わせ年を最適化（メインロジック）
      
      実行フロー:
      1. 7組み合わせ生成（2年学習→1年テスト）
      2. 各組み合わせを評価（データ処理→学習→評価）
      3. RMSE基準でソート
      4. 上位5組み合わせ表示
      5. 結果をテキストファイル保存
      6. 2025年予測の推奨組み合わせ提示
      
      出力例:
      ================================================================================
      LightGBMモデル - 学習年組み合わせ最適化結果
      ================================================================================
      
      総実行回数: 7
      成功回数: 7
      
      【上位5組み合わせ（RMSE基準）】
      
      1位: 学習年 2016,2017 → テスト年 2018
         RMSE: 152.582 kW, R²: 0.9120, MAE: 100.423 kW
         実行時間: 14.2秒
      
      2位: 学習年 2022,2023 → テスト年 2024
         RMSE: 165.619 kW, R²: 0.9193, MAE: 107.717 kW
         実行時間: 11.5秒
      
      【統計情報】
      RMSE - 平均: 169.1, 標準偏差: 13.2
      RMSE - 最小: 152.6, 最大: 195.4
      
      🎯 2025年電力需要予測 - 最適学習年組み合わせ推奨
      
      推奨: 学習年 2022,2023,2024 → テスト年 2025
      推定RMSE: 165-175 kW
      
      結果を 2025-10-19_LightGBM_optimize_years.txt に保存しました
      """
      combinations = self.generate_rolling_combinations()
      results = []
      
      # 各組み合わせを評価（プログレスバー表示）
      for i, (train_years, test_year) in enumerate(combinations):
          print(f"[{i+1:2d}/{len(combinations):2d}] {train_years}→{test_year}: ", end="")
          result = self.evaluate_year_combination(train_years, test_year)
          results.append(result)
          print(f"成功 (RMSE: {result['rmse']:.1f})")
      
      # RMSE基準でソート
      results.sort(key=lambda x: x['rmse'])
      
      # 上位5組み合わせ表示
      self.display_top_combinations(results[:5])
      
      # 結果をテキストファイル保存
      self.save_results(results)
      
      # メモ帳自動オープン
      os.startfile(self.results_file)
  ```
- **プログレスバー**: tqdmライブラリ使用
- **結果保存**: テキストファイル（UTF-8エンコーディング）
- **優先度**: P0 (最重要)

##### F019: 結果保存機能 (*_optimize_years.py)
- **目的**: 組み合わせ検証結果の永続化
- **ファイル形式**: プレーンテキスト（UTF-8エンコーディング）
- **ファイル名**: `YYYY-MM-DD_{ModelName}_optimize_years.txt`
- **保存場所**: `train/{ModelName}/`フォルダ
- **内容**:
  - 総実行回数、成功回数
  - 上位5組み合わせ（RMSE/R2/MAE/実行時間）
  - 統計情報（平均/標準偏差/最小/最大）
  - 最優秀組み合わせ
  - 2025年予測推奨組み合わせ
  - Tomorrow予測実行推奨コマンド
- **自動オープン**: `os.startfile()`によるメモ帳自動起動
- **優先度**: P1 (高)

##### F020: Webダッシュボード組み合わせ検証実行機能
- **目的**: ブラウザからワンクリックで組み合わせ検証実行
- **実装仕様**:
  ```javascript
  // JavaScript実装
  document.getElementById('optimizeYearsBtn').addEventListener('click', async ()=>{
      const btn = document.getElementById('optimizeYearsBtn');
      btn.textContent='実行中...'; 
      btn.disabled=true; 
      btn.classList.add('running');
      
      try{
          const res = await postJson('/run-optimize-years', { model: selectedModel }, btn);
          console.log('Optimize years response:', res);
          alert('組み合わせ検証終了: ' + (res.status||res.message));
          
          // 結果ファイルが保存されたことをユーザーに通知
          // （メモ帳は自動的にサーバー側でオープンされる）
      }catch(e){ 
          alert('エラー: '+e); 
      }
      
      btn.textContent='組み合わせ検証'; 
      btn.disabled=false; 
      btn.classList.remove('running');
  });
  ```
- **実行中表示**: マゼンタ系発光アニメーション
- **完了通知**: アラート「組み合わせ検証終了」
- **エラーハンドリング**: アラート「エラー: {メッセージ}」
- **優先度**: P0 (最重要)

## 3. ユースケース/業務フロー

### 3.1. 非機能要件

#### 3.1.1. 性能要件
| 項目 | 要件 | 測定方法 | 目標値 |
|------|------|----------|--------|
| **予測精度** | RMSE | テストデータ評価 | < 200kW |
| **予測精度** | R2スコア | テストデータ評価 | > 0.9 |
| **メモリ効率** | 使用量削減 | float32最適化 | 50%削減 |
| **処理速度** | 学習時間 | 並列処理効果 | 30%短縮 |
| **レスポンス時間** | 予測実行時間 | 単一予測処理 | < 1秒 |
| **スループット** | バッチ処理性能 | 1000件予測処理 | < 10秒 |
| **操作時間（v2.0）** | CLI→WebUI削減 | モデル選択〜実行 | 97%削減（30秒→1秒） |
| **確認時間（v2.0）** | 結果表示時間 | 結果自動表示 | 92%削減（60秒→5秒） |
| **切替時間（v2.0）** | モデル切替時間 | ボタンクリック | 93%削減（30秒→2秒） |
| **HTTPレスポンス（v2.0）** | WebUI応答時間 | APIエンドポイント | < 200ms |
| **組み合わせ検証時間（v3.0）** | LightGBM | 7組み合わせ実行 | 約5分 |
| **組み合わせ検証時間（v3.0）** | RandomForest | 7組み合わせ実行 | 約6分 |
| **組み合わせ検証時間（v3.0）** | PyCaret | 7組み合わせ実行 | 約12分 |
| **組み合わせ検証時間（v3.0）** | Keras | 7組み合わせ実行 | 約30分 |
| **精度改善率（v3.0）** | RMSE改善 | ベースライン比較 | 17.6%改善（LightGBM） |

#### 3.1.2. 可用性要件
- **稼働率**: 99.5%以上
- **障害復旧時間**: RTO < 1時間
- **データ復旧時間**: RPO < 30分
- **エラー率**: < 0.1%
- **サーバー稼働（v2.0）**: HTTPサーバー連続稼働30日以上
- **組み合わせ検証成功率（v3.0）**: 100%（全組み合わせ正常完了）

#### 3.1.3. 信頼性要件
- **データ整合性**: 100%保証
- **予測結果再現性**: 同一入力で同一出力保証
- **モデル安定性**: 連続稼働30日間エラー無し
- **バックアップ**: 日次自動バックアップ
- **実行履歴（v2.0）**: server.logでの完全トレーサビリティ
- **組み合わせ検証履歴（v3.0）**: 日付付き結果ファイルでの完全トレーサビリティ

#### 3.1.4. セキュリティ要件
- **アクセス制御**: ファイルシステム権限による制御
- **データ暗号化**: 機密データの暗号化保存
- **ログ監査**: 操作ログの記録・保存 (robust_model_operation + server.log + logs.log)
- **脆弱性対策**: 固定ライブラリバージョンによる安定性確保
- **ポートセキュリティ（v2.0）**: localhost限定アクセス（デフォルト）

#### 3.1.5. 保守性要件
- **コード品質**: PEP 8準拠100% (flake8検証)
- **型安全性**: 型ヒント完全実装 (mypy検証)
- **統一アーキテクチャ**: @dataclass + robust_model_operation統一
- **文書化**: docstring、技術文書完備
- **モジュール分離**: 機能別独立モジュール設計 (17モジュール: v1.0の11 + v2.0の2 + v3.0の4)
- **ログ追跡（v2.0）**: server.logでの全操作履歴確認
- **組み合わせ検証追跡（v3.0）**: 日付付き結果ファイルでの最適化履歴確認

### 3.2. ユースケースフロー（v3.0版）

#### 3.2.1. Web UI利用フロー（組み合わせ検証）
1. **サーバー起動**: `py -3.10 server.py`（1回のみ）
2. **ブラウザ自動起動**: http://localhost:8002/
3. **Webダッシュボード表示**
4. **モデル選択**: [LightGBM]ボタンクリック
5. **組み合わせ検証実行**: [組み合わせ検証シミュレーション]ボタンクリック
   - 実行中: マゼンタ系発光アニメーション
   - subprocess: LightGBM_optimize_years.py実行
   - 7組み合わせ自動検証（2年学習→1年テスト）
   - RMSE/R2/MAE自動記録
6. **結果自動保存・表示**:
   - テキストファイル: `2025-10-XX_LightGBM_optimize_years.txt`
   - メモ帳自動オープン
   - アラート: 「組み合わせ検証終了」
7. **推奨組み合わせで学習実行**:
   - 結果ファイルから推奨年を確認（例: 2022,2023,2024）
   - [2022][2023][2024]ボタンクリック
   - [データ処理]ボタン → [学習]ボタン
8. **結果表示**: RMSE/R2/MAE自動表示、グラフ表示（16:9）

#### 3.2.2. CLI利用フロー（組み合わせ検証）
```powershell
# 組み合わせ検証実行
cd AI_v3
py -3.10 train/LightGBM/LightGBM_optimize_years.py

# 実行結果確認（メモ帳自動オープン）
# → 上位5組み合わせ確認
# → 2025年予測推奨組み合わせ確認

# 推奨組み合わせで学習
$env:AI_TARGET_YEARS = "2022,2023,2024"
py -3.10 data/data.py
py -3.10 train/LightGBM/LightGBM_train.py
```

#### 3.2.3. CLI利用フロー（v1.0・v2.0互換）
v2.0と完全同一のCLI操作も継続サポート。

## 4. 機能要件

### 4.1. データ仕様

#### 4.1.1. 入力データ仕様（v1.0と同一）
v2.0と完全同一。

#### 4.1.2. 中間データ仕様（v1.0と同一）
v2.0と完全同一。

#### 4.1.3. 出力データ仕様

##### 学習済みモデルファイル（v1.0と同一）
v2.0と完全同一。

##### ログファイル（v2.0新規）
v2.0と完全同一。

##### 組み合わせ検証結果ファイル（v3.0新規）
| 項目 | 仕様 | 実装詳細 |
|------|------|---------|
| **ファイル名** | `YYYY-MM-DD_{ModelName}_optimize_years.txt` | 日付付きで自動生成 |
| **保存場所** | `train/{ModelName}/` | モデルフォルダ内 |
| **形式** | プレーンテキスト | UTF-8エンコーディング |
| **内容** | 総実行回数、成功回数、上位5組み合わせ、統計情報、最優秀組み合わせ、2025年予測推奨、Tomorrow予測コマンド | 包括的な最適化結果 |
| **自動オープン** | `os.startfile()` | メモ帳で自動表示 |

**ファイル内容例**:
```text
================================================================================
LightGBMモデル - 学習年組み合わせ最適化結果
================================================================================

総実行回数: 7
成功回数: 7

【上位5組み合わせ（RMSE基準）】

1位: 学習年 2016,2017 → テスト年 2018
   RMSE: 152.582 kW
   R²: 0.9120
   MAE: 100.423 kW
   実行時間: 14.2秒

2位: 学習年 2022,2023 → テスト年 2024
   RMSE: 165.619 kW
   R²: 0.9193
   MAE: 107.717 kW
   実行時間: 11.5秒

【統計情報】
RMSE - 平均: 169.1, 標準偏差: 13.2
RMSE - 最小: 152.6, 最大: 195.4
R² - 平均: 0.9120, 標準偏差: 0.0144

🏆 【最優秀組み合わせ】
学習年: 2016,2017
テスト年: 2018
RMSE: 152.582 kW, R²: 0.9120, MAE: 100.423 kW

🎯 2025年電力需要予測 - 最適学習年組み合わせ推奨

推奨: 学習年 2022,2023,2024 → テスト年 2025
推定RMSE: 165-175 kW

📋 Tomorrow予測実行推奨コマンド:
set AI_TARGET_YEARS=2022,2023,2024,2025
py -3.10 tomorrow/LightGBM/LightGBM_tomorrow.py
```

## 5. 非機能要件

### 5.1. インターフェース要件

#### 5.1.1. ファイルインターフェース（v1.0と同一）
v2.0と完全同一。

#### 5.1.2. HTTPインターフェース（v3.0拡張）

##### APIエンドポイント
| メソッド | パス | 説明 | リクエスト | レスポンス | v3.0追加 |
|---------|------|------|-----------|-----------|---------|
| **POST** | /run-data | データ処理実行 | `{model, years}` | `{output, error}` | - |
| **POST** | /run-train | モデル学習実行 | `{model, years}` | `{output, error}` | - |
| **POST** | /run-tomorrow-data | 最新データ取得 | `{model}` | `{output, error}` | - |
| **POST** | /run-tomorrow | 予測実行 | `{model}` | `{output, error}` | - |
| **GET** | /available-years | 利用可能年一覧 | なし | `{years: [...]}` | - |
| **GET** | / | ダッシュボード表示 | なし | HTML | - |
| **POST** | /run-optimize-years | 組み合わせ検証実行 | `{model}` | `{output, error}` | ★v3.0新規 |

**v3.0追加エンドポイント詳細**:
```python
# POST /run-optimize-years
# リクエスト: { "model": "LightGBM" }
# レスポンス: { 
#   "output": "組み合わせ検証完了。結果を2025-10-XX_LightGBM_optimize_years.txtに保存しました。",
#   "error": ""
# }
# タイムアウト: 40分（Keras対応）
```

##### HTTPステータスコード
v2.0と完全同一（200 OK, 500 Internal Server Error, 404 Not Found, 405 Method Not Allowed）。

## 6. データ要件

### 6.1. 運用要件

#### 6.1.1. システム運用
- **OS**: Windows 10/11, macOS, Linux (Ubuntu 20.04+)
- **Python**: 3.10.11 (推奨)
- **メモリ**: 最小8GB、推奨16GB
- **ストレージ**: 最小10GB、推奨50GB
- **ブラウザ（v2.0）**: Chrome/Firefox/Edge最新版
- **ポート（v2.0）**: デフォルト8002（環境変数AI_SERVER_PORTで変更可能）

#### 6.1.2. 監視要件
- **性能監視**: CPU使用率、メモリ使用率、実行時間
- **精度監視**: 予測精度の経時変化
- **エラー監視**: 実行エラー、データエラー
- **ログ監視**: アクセスログ、エラーログ
- **サーバー監視（v2.0）**: HTTPサーバー稼働状態、APIレスポンスタイム
- **組み合わせ検証監視（v3.0）**: 検証結果の経時変化、最優秀組み合わせの安定性

#### 6.1.3. バックアップ要件
- **データバックアップ**: 日次フルバックアップ
- **モデルバックアップ**: 学習完了時自動バックアップ
- **設定バックアップ**: 設定変更時即座にバックアップ
- **ログバックアップ（v2.0）**: server.logの定期バックアップ
- **組み合わせ検証結果バックアップ（v3.0）**: 日付付きファイル自動保存
- **保存期間**: 30日間

## 7. 外部インターフェース要件

### 7.1. 制約事項

#### 7.1.1. 技術制約

##### ライブラリバージョン固定（v1.0・v2.0と同一）
v2.0と完全同一（requirements.txt変更なし）。

##### 実行環境制約
| 項目 | 制約 | 実装対応 | v2.0での追加 | v3.0での追加 |
|------|------|---------|------------|------------|
| **Python バージョン** | 3.10.11 | PyCaret互換性重視 | 変更なし | 変更なし |
| **メモリ制限** | 16GB以下 | float32最適化で50%削減 | +50MB（サーバー） | 変更なし |
| **処理時間制限** | 学習最大2時間 | 並列処理で30%短縮 | 変更なし | 組み合わせ検証最大40分（Keras） |
| **ストレージ** | 最小10GB | モデル・データ・ログ | +2MB（server.py, index.html, server.log） | +1.7MB（*_optimize_years.py×4, 結果ファイル） |
| **ポート制限（v2.0）** | 1024-65535 | デフォルト8002 | 環境変数で変更可 | 変更なし |

##### Webサーバー制約（v2.0新規、v3.0継承）
v2.0と完全同一（同時接続数10、タイムアウト40分、POSTボディ10MB、ブラウザ互換性）。

#### 7.1.2. データ制約（v1.0と同一）
v2.0と完全同一。

#### 7.1.3. 運用制約

##### システム運用制約
| 項目 | 制約 | 実装対応 | v2.0での追加 | v3.0での追加 |
|------|------|---------|------------|------------|
| **同時実行制限** | 最大4プロセス | 並列処理制御 | 変更なし | 変更なし |
| **ファイルロック** | 排他制御必須 | ファイルアクセス制御 | 変更なし | 変更なし |
| **メモリ監視** | psutil監視 | robust_model_operation | 変更なし | 変更なし |
| **ガベージコレクション** | 自動実行 | `gc.collect()` | 変更なし | 変更なし |
| **サーバー起動（v2.0）** | 1インスタンスのみ | ポート排他制御 | NEW | 継承 |
| **組み合わせ検証実行（v3.0）** | 順次実行 | ファイルロック制御 | - | NEW |

##### API制約（v1.0と同一）
v2.0と完全同一。

## 8. 運用・保守要件

### 8.1. 品質要件

#### 8.1.1. 機能品質
- **正確性**: 予測精度目標達成率 > 95%
- **完全性**: 全機能要件実装率 100%（v3.0: 20機能、v2.0: 15機能、v1.0: 12機能）
- **適合性**: 仕様準拠率 100%

#### 8.1.2. 性能品質
- **時間効率性**: 処理時間目標達成率 > 90%
- **資源効率性**: メモリ使用量目標達成率 > 90%
- **容量**: 最大データ量処理可能
- **操作効率（v2.0）**: WebUI操作時間削減率 > 90%
- **最適化効率（v3.0）**: 組み合わせ検証時間削減率 > 85%

#### 8.1.3. 互換性品質
- **共存性**: 他システムとの競合なし
- **相互運用性**: 標準形式での入出力
- **置換性**: モデル交換可能性
- **下位互換性（v2.0）**: v1.0 CLI完全サポート
- **下位互換性（v3.0）**: v1.0 CLI + v2.0 WebUI完全サポート

#### 8.1.4. 使用性品質
- **適切度認識性**: 機能理解容易性
- **習得性**: 新規利用者習得時間（CLI: 1日、WebUI: 30分、組み合わせ検証: 10分）
- **運用性**: 日常運用の自動化率 > 95%
- **UI/UX品質（v2.0）**: 直感的操作性、視認性、アクセシビリティ
- **最適化容易性（v3.0）**: ワンクリック組み合わせ検証、結果ファイル自動生成

#### 8.1.5. 信頼性品質
- **成熟性**: 既知障害率 < 0.1%
- **可用性**: システム稼働率 > 99.5%
- **障害許容性**: 単一障害での停止なし
- **回復性**: 障害復旧時間 < 1時間
- **サーバー安定性（v2.0）**: 連続稼働30日以上
- **組み合わせ検証安定性（v3.0）**: 成功率100%（全組み合わせ正常完了）

#### 8.1.6. セキュリティ品質
v2.0と完全同一。

#### 8.1.7. 保守性品質
- **モジュール性**: 独立モジュール設計（17モジュール: v1.0の11 + v2.0の2 + v3.0の4）
- **再利用性**: コンポーネント再利用率 > 80%
- **解析性**: 問題原因特定時間 < 30分（server.log + 組み合わせ検証結果ファイルで追跡容易）
- **修正性**: 不具合修正時間 < 4時間
- **試験性**: 自動テスト実行可能

#### 8.1.8. 移植性品質
v2.0と完全同一。

## 9. 制約条件・前提条件・依存関係

### 9.1. 受入基準

#### 9.1.1. 機能受入基準
- 全機能要件 (F001-F020) の正常動作確認
- 4種類のモデル学習・予測実行確認
- データ処理パイプライン正常動作確認
- 可視化グラフ品質基準クリア
- HTTPサーバー稼働確認（v2.0）
- Webダッシュボード全機能動作確認（v2.0）
- **組み合わせ検証機能動作確認（v3.0）**
- **組み合わせ検証結果ファイル生成確認（v3.0）**

#### 9.1.2. 性能受入基準
- RMSE < 200kW達成
- R2スコア > 0.9達成
- メモリ使用量50%削減達成
- 処理時間30%短縮達成
- 操作時間97%削減達成（v2.0）
- HTTPレスポンス < 200ms達成（v2.0）
- **組み合わせ検証時間5-30分達成（v3.0）**
- **組み合わせ検証成功率100%達成（v3.0）**
- **RMSE改善率17.6%達成（v3.0、LightGBM）**

#### 9.1.3. 品質受入基準
- コードカバレッジ90%以上
- PEP 8準拠100%
- セキュリティスキャン合格
- 負荷テスト合格
- ブラウザ互換性テスト合格（v2.0）
- **組み合わせ検証7パターン実行テスト合格（v3.0）**

#### 9.1.4. 運用受入基準
- 30日間連続稼働テスト合格
- 障害復旧テスト合格
- バックアップ・リストアテスト合格
- 運用ドキュメント完備
- HTTPサーバー連続稼働30日以上（v2.0）
- **組み合わせ検証結果ファイル自動生成確認（v3.0）**

### 9.2. リスク管理

#### 9.2.1. 技術リスク
| リスク項目 | 影響度 | 発生確率 | 対策・軽減措置 | v2.0での追加対策 | v3.0での追加対策 |
|-----------|--------|----------|---------------|----------------|----------------|
| **ライブラリ互換性問題** | 高 | 中 | バージョン固定、仮想環境分離 | 変更なし | 変更なし |
| **メモリ不足エラー** | 中 | 低 | float32最適化、ガベージコレクション | サーバーメモリ監視 | 変更なし |
| **モデル精度劣化** | 高 | 低 | 4モデル並行、アンサンブル予測 | 変更なし | 組み合わせ検証で最適年探索 |
| **処理性能不足** | 中 | 中 | 並列処理、最適化アルゴリズム | 変更なし | 変更なし |
| **API制限・障害** | 中 | 中 | リトライ機能、フォールバック | 変更なし | 変更なし |
| **ブラウザ互換性（v2.0）** | 低 | 中 | 主要ブラウザテスト | NEW | 継承 |
| **ポート競合（v2.0）** | 低 | 低 | 環境変数AI_SERVER_PORTで変更 | NEW | 継承 |
| **組み合わせ検証タイムアウト（v3.0）** | 低 | 中 | Keras: 30分、他: 5-12分（実測済み） | - | NEW |

#### 9.2.2. データリスク（v1.0と同一）
v2.0と完全同一。

#### 9.2.3. 運用リスク
| リスク項目 | 影響度 | 発生確率 | 対策・軽減措置 | v2.0での追加対策 | v3.0での追加対策 |
|-----------|--------|----------|---------------|----------------|----------------|
| **システム障害** | 高 | 低 | 監視機能、自動復旧 | HTTPサーバー自動再起動 | 変更なし |
| **人的ミス** | 中 | 中 | 自動化推進、エラーチェック | WebUI操作で誤入力防止 | 組み合わせ検証で試行錯誤不要 |
| **ストレージ不足** | 中 | 低 | 容量監視、自動クリーンアップ | server.logローテーション | 組み合わせ検証結果ファイル定期削除 |
| **セキュリティ問題** | 高 | 低 | アクセス制御、定期監査 | localhost限定アクセス | 変更なし |

## 10. 用語集

| 用語 | 定義・説明 |
|------|-----------|
| **@dataclass** | Python標準ライブラリの設定値統一管理クラス |
| **robust_model_operation** | エラーハンドリング・性能監視を提供する統一デコレータ |
| **RMSE** | Root Mean Square Error：予測誤差の二乗平均平方根 |
| **R2スコア** | 決定係数：予測精度を表す指標（1.0が完全予測） |
| **float32** | 32ビット浮動小数点型：メモリ50%削減データ型 |
| **EarlyStopping** | 過学習防止のための早期学習停止手法 |
| **アンサンブル** | 複数モデルの予測結果を統合する手法 |
| **勾配ブースティング** | 弱学習器を逐次改善するアンサンブル手法 |
| **Auto-ML** | Automated Machine Learning：機械学習プロセス自動化 |
| **StandardScaler** | 標準化処理：平均0、分散1への正規化 |
| **並列処理** | n_jobs=-1：CPU最大活用による処理速度向上 |
| **ガベージコレクション** | gc.collect()：メモリ最適化のための自動実行 |
| **HTTPサーバー（v2.0）** | http.serverベースのWebインターフェース提供サーバー |
| **Webダッシュボード（v2.0）** | ブラウザベースの直感的操作UI |
| **環境変数AI_TARGET_YEARS（v2.0）** | 学習年指定用環境変数（例: "2022,2023,2024"） |
| **環境変数AI_SERVER_PORT（v2.0）** | HTTPサーバーポート番号指定用（デフォルト: 8002） |
| **server.log（v2.0）** | HTTPサーバー実行履歴ログファイル |
| **ThreadingTCPServer（v2.0）** | 並行接続対応のTCPサーバー実装 |
| **subprocess（v2.0）** | Pythonスクリプト実行用標準ライブラリ |
| **組み合わせ検証（v3.0）** | ローリング時系列交差検証による最適学習年探索機能 |
| **ローリング時系列交差検証（v3.0）** | Rolling Time-Series Cross-Validation：2年学習→1年テストの連続検証（7パターン） |
| ***_optimize_years.py（v3.0）** | 組み合わせ検証スクリプト（Keras, LightGBM, PyCaret, RandomForest × 各424行） |
| **組み合わせ検証結果ファイル（v3.0）** | YYYY-MM-DD_Model_optimize_years.txt：最適化結果記録ファイル |
| **logs.log（v3.0）** | 組み合わせ検証専用ログファイル |

---
