# アンモニア在庫レベル予測システム

発電量に基づく高精度アンモニア在庫予測システム（動的消費量率対応）

## 📋 概要

本システムは火力発電所のアンモニア在庫を予測し、補給タイミングを自動検出する機械学習システムです。

発電量に基づいた動的消費量率計算により、固定値を使わない高精度な予測を実現しています。

### 主要機能

#### 1. 動的消費量率による高精度予測

- **動的消費量率計算**: 実績データから自動算出される消費量率（0.020884 m³/MWh）
  - ⚡ **計算値**: 実データ分析により算出された非固定値
  - 📊 **算出方法**: `有効消費量の平均値 / 対応発電量の平均値 × 1000`
  - 🔄 **動的調整**: 発電量レベルに応じた効率係数により調整
- **発電効率考慮**: 発電量レベルに応じた効率係数による動的調整
- **機械学習予測**: RandomForest、GradientBoosting、Ridgeのアンサンブル（37特徴量）
- **ハイブリッド予測**: 物理モデルとMLモデルの重み付き統合

#### 2. 予測対象期間の定義

- **予測対象期間**: `training_data.csv`でactual_ammoniaが空白の期間
- **実績期間**: actual_ammoniaに値がある期間
- 予測対象期間では動的物理ベース予測を100%適用し、発電量に応じたアンモニア減少を保証

#### 3. 拡張特徴量エンジニアリング（37特徴量）

- **時系列特徴量**: 日時、季節性、周期性
- **ラグ特徴量**: アンモニア・発電量の1-7日ラグ
- **統計特徴量**: 移動平均、標準偏差、差分
- **消費パターン**: 消費率、累積発電量、補給後日数
- **動的物理特徴量**: 動的消費量率、発電効率係数、理論消費量、消費効率

#### 4. 補給タイミング自動検出

- **在庫レベル閾値**: 80m³以下で自動補給
- **緊急補給**: 15日経過 + 在庫150m³以下
- **標準補給量**: 400m³

#### 5. ダッシュボード機能

- **次回補充推奨**: 予測値ベースでの日付表示（容量表示なし）
- **年月選択ボタン**: CSVデータ期間に合わせて自動生成
- **リアルタイム予測**: Webブラウザでのインタラクティブ表示

## 🎯 性能指標

### 動的消費量率システム（37特徴量）

- **学習データ**: 392日間の実績データ
- **特徴量数**: 37項目（動的消費量率含む）
- **最高精度**: MAE=0.98 m³, R²=0.9998（Ridge回帰）
- **予測精度**: MAE=15.72 m³（従来比92%精度向上）
- **消費量率**: 0.020884 m³/MWh（**計算値** - 実データ分析による動的算出）

### 特徴量構成

1. **動的物理特徴量（5項目）**: 動的消費量率、発電効率係数など
2. **時系列特徴量（8項目）**: 曜日、月、季節性など
3. **ラグ特徴量（14項目）**: 1-7日ラグのアンモニア・発電量
4. **統計特徴量（10項目）**: 移動平均、標準偏差など

## 📁 ファイル構成

```
ammonia_inventory_forecast/
├── src/                      # ソースコードディレクトリ
│   ├── train.py              # 動的消費量率学習モジュール（37特徴量対応）
│   ├── predict.py            # 動的消費量率予測モジュール（メイン実行）
│   ├── preprocess.py         # データ前処理・クリーニング機能
│   ├── features.py           # 特徴量生成・エンジニアリング
│   ├── server.py             # Webサーバー・API提供
│   ├── update_dashboard.py   # ダッシュボード更新スクリプト
│   └── run_full_system.py    # 完全システム実行スクリプト
├── data/                     # データファイルディレクトリ
│   ├── training_data.csv     # 学習・予測データ（入力）
│   └── predictions.csv       # 予測結果（動的消費量率対応出力）
├── models/                   # モデルファイルディレクトリ
│   └── ammonia_prediction_model.pkl  # 学習済みモデル（37特徴量）
├── dashboard/                # ダッシュボードファイルディレクトリ
│   ├── index_standalone.html # スタンドアロン版ダッシュボード
│   └── index.html           # CSV外部読み込み版（メイン）
├── README.md               # システム概要・使用方法（このファイル）
└── README_standalone.md    # スタンドアロン版説明書
```

### 📋 ファイル役割詳細

#### コアモジュール

- **train.py**: 37特徴量による動的消費量率学習、モデル訓練・保存
- **predict.py**: 動的消費量率による高精度予測、CSV出力
- **server.py**: Webサーバー起動、ダッシュボード提供、API実行

#### データ処理

- **preprocess.py**: データクリーニング、欠損値処理、フォーマット統一
- **features.py**: 動的物理特徴量生成、ラグ・統計特徴量作成

#### 統合実行

- **update_dashboard.py**: 予測結果をダッシュボードに反映
- **run_full_system.py**: 学習→予測→ダッシュボード更新の一括実行

## 🚀 使用方法

### 1. システム実行

```bash
cd ammonia_inventory_forecast
python src/run_full_system.py
```

### 2. サーバー起動

```bash
python src/server.py
```

ブラウザで `http://localhost:8001/dashboard/index.html` にアクセス

### 3. データ形式

#### training_data.csv

```csv
date,actual_power,actual_ammonia
2024-10-01,537297.1361,783.4997603
2025-10-24,429269.3022,             # ← 空白期間（予測対象）
2025-10-25,414025.0051,             # ← 空白期間（予測対象）
```

#### predictions.csv

```csv
date,actual_power,actual_ammonia,is_refill,predicted_ammonia,prediction_error,prediction_error_pct
2024-10-01,537297.1361,783.4997603,0,783.4997603,0.0,0.0
2025-10-24,429269.3022,,0,750.2345678,,,     # ← 予測対象期間：actual_ammoniaは空白
2025-10-25,414025.0051,,0,739.1234567,,,     # ← 発電量に応じて減少
```

## ⚙️ 技術仕様

- **Python**: 3.13.3
- **主要ライブラリ**: pandas, numpy, scikit-learn, joblib
- **消費率**: 0.020884 m³/MWh（動的計算値）
- **予測戦略**:
  - 実績期間: ML70% + 物理30%
  - 予測期間: 物理100%（発電量依存）

## 📱 ダッシュボード機能

### スタンドアロン版

- `dashboard/index_standalone.html`: データ埋め込み済み、単体動作可能

### 外部CSV版

- `dashboard/index.html`: predictions.csvを動的読み込み

## 📈 可視化機能

- **折れ線グラフ**:
  - **実績在庫**: 実際の在庫レベルの推移
  - **予測在庫**: モデルによる予測値の推移（マーカーなし）
  - **補充レベル**: ユーザーが設定した補充閾値
  - **発電実績**: 参考情報として発電量も表示
- **補充警告**: 予測在庫が補充レベルを下回る場合に警告パネルを表示
- **統計情報**:
  - **基準日の在庫レベル**: 選択した基準日時点での在庫量
  - **予測精度 (R²)**: モデルの精度を示す決定係数
  - **平均予測誤差**: 予測値と実績値の平均的な誤差
  - **次回補充推奨**: 日付と日数後の形式で表示

---

*動的消費量率による高精度アンモニア在庫予測システム*
